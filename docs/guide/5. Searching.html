<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>5. Searching</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    <h1><a name="5. Searching">5. Searching</a></h1>The plugin provides 2 ways to send search requests.
<ul class="star">
<li>You can use the <code>elasticSearchService</code> and its public <code>search</code> method for cross-domain searching, meaning that ElasticSearch</li>
</ul><p class="paragraph"/>may analyze multiple indices and return hits of different types (=different domains).
<div class="code"><pre>def res = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
// 'res' search results may contains multiple types of results</pre></div>
<ul class="star">
<li>You can use the injected dynamic method in the domain for domain-specific searching.</li>
</ul><p class="paragraph"/><div class="code"><pre>def res = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
// 'res' search results contains only Tweet instances</pre></div><p class="paragraph"/>These search methods return a <code>Map</code> containing 3 entries:
<ul class="star">
<li>a <code>total</code> entry, representing the total number of hits found</li>
<li>a <code>searchResults</code> entry, containing the hits</li>
<li>a <code>scores</code> entry, containing the hits scores</li>
</ul><p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def res = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
println <span class="java&#45;quote">"Found $&#123;res.total&#125; result(s)"</span>
res.searchResults.each &#123;
    println it.message
&#125;<p class="paragraph"/>def res = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
println <span class="java&#45;quote">"Found $&#123;res.total&#125; result(s)"</span>
res.searchResults.each &#123;
    <span class="java&#45;keyword">if</span>(it <span class="java&#45;keyword">instanceof</span> Tweet) &#123;
        println it.message
    &#125; <span class="java&#45;keyword">else</span> &#123;
        println it.toString()
    &#125;
&#125;</pre></div><p class="paragraph"/>If you're willing to retrieve only the number of hits for a peculiar query, you can use the <code>countHits()</code>
method. It will only return an <code>Integer</code> representing the total hits matching your query.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def res = Tweet.countHits(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
println <span class="java&#45;quote">"Found $&#123;res&#125; result(s)"</span><p class="paragraph"/>def res = elasticSearchService.countHits(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;indices:'test'&#93;)
println <span class="java&#45;quote">"Found $&#123;res&#125; result(s)"</span></pre></div><h2><a name="5.1 Query Strings">5.1 Query Strings</a></h2>The search method injected in the domain or the <code>ElasticSearchService</code> has multiple signatures available.
You can pass it a simple <code>String</code> to compute your search request. That string will be parsed by the <strong class="bold">Lucene query parser</strong>
so feel free to use its syntax to do more specific search query.<p class="paragraph"/>You can find out about the syntax on the <a href="http://lucene.apache.org/java/3_0_3/queryparsersyntax.html" target="blank">Apache Lucene website</a>.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def results = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
def resultsTweets = Tweet.search(<span class="java&#45;quote">"message:$&#123;params.query&#125;"</span>)</pre></div><h2><a name="5.2 Query Closure">5.2 Query Closure</a></h2>You can use the <a href="http://www.elasticsearch.org/guide/reference/groovy-api/search.html" target="blank">Groovy Query DSL</a> to build your search query as a <code>Closure</code>.
The format of the search <code>Closure</code> follow the same JSON syntax as the <a href="http://www.elasticsearch.org/guide/reference/api/search/" target="blank">ElasticSearch REST API</a>
and the <a href="http://www.elasticsearch.org/guide/reference/java-api/query-dsl.html" target="blank">Java Query DSL</a>.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def result = elasticSearchService.search(searchType:'dfs_query_and_fetch') &#123;
  bool &#123;
      must &#123;
          query_string(query: params.query)
      &#125;
      <span class="java&#45;keyword">if</span> (params.firstname) &#123;
          must &#123;
              term(firstname: params.firstname)
          &#125;
      &#125;
  &#125;
&#125;</pre></div><h2><a name="5.3 Highlighting">5.3 Highlighting</a></h2>The search method support highlighting: automatic wrapping of the matching terms in the search results with
HTML/XML/Whatever tags.
You can activate this with a <code>Closure</code> containing the highlight settings in the search method <code>highlight</code> parameter.
The format of the <code>Closure</code> for defining the highlight settings is the same as the
<a href="http://www.elasticsearch.org/guide/reference/api/search/highlighting.html" target="blank">ElasticSearch REST API</a>.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>// Define the pre &#38; post tag that will wrap each term matched in the document.
def highlighter = &#123;
  field 'message'
  field 'tags.name'
  preTags '&#60;strong&#62;'
  postTags '&#60;/strong&#62;'
&#125;<p class="paragraph"/>def results = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: highlightSettings&#93;)</pre></div><p class="paragraph"/><h3>Highlight results</h3>
If a search result is found, the <code>search</code> method will add a <code>highlight</code> entry in the map result.
That entry contains a <code>List</code> with every highlighted fragments/fields found for each hit.<p class="paragraph"/><div class="code"><pre>def results = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: &#123; field 'message' &#125;&#93;)
def highlighted = results.highlight<p class="paragraph"/>results?.searchResults?.eachWithIndex &#123; hit, index &#45;&#62;
    // Retrieve the 'message' field fragments <span class="java&#45;keyword">for</span> the current hits
    def fragments = highlighted&#91;index&#93;.message?.fragments<p class="paragraph"/>    // Print the fragment
    println fragments?.size() ? fragments&#91;0&#93; : ''
&#125;</pre></div><p class="paragraph"/><h3>Highlighted fields</h3>
To determine which fields are to be processed by ElasticSearch, use the <code>field</code> setting.
You can call the <code>field</code> setting as many time as you want to add any field.<p class="paragraph"/><strong class="bold">Signature</strong>
<div class="code"><pre>field &#60;fieldName&#62;&#91;, &#60;fragmentSize&#62;&#91;, &#60;numberOfFragment&#62;&#93;&#93;</pre></div><p class="paragraph"/><strong class="bold">Examples</strong>
<div class="code"><pre>def highlightSettings = &#123;
    field 'message'                    // Add the 'message' field in the highlighted fields list
    field 'tags.name'                  // Add the 'name' field contained in the 'tags' field of
                                       // the document in the highlighted fields list
    field 'thatAwesomeField', 0, 20    // Add the 'thatAwesomeField' field with
                                       // some values fixed <span class="java&#45;keyword">for</span> fragmentSize and numberOfFragment parameters
&#125;<p class="paragraph"/>def highlightSettings2 = &#123;
    field '_all'                       // Add the special '_all' field in the highlighted fields list
&#125;<p class="paragraph"/>def results = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: highlightSettings&#93;)
def results2 = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: highlightSettings2&#93;)</pre></div><p class="paragraph"/><h3>Highlighting tags</h3>
By default, ElasticSearch will use emphasis tag "<code>&#60;em&#62;...&#60;/em&#62;</code>" to wrap the matching text.
You can customize the tags with the <code>preTags</code> and <code>postTags</code> settings.<p class="paragraph"/><div class="code"><pre>def highlightSettings = &#123;
    field 'message'
    preTags '&#60;myAweSomeTag&#62;'
    postTags '&#60;/myAweSomeTag&#62;'
&#125;</pre></div>
    </body>
</html>
