<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>ElasticSearch Grails Plugin 0.0.4.5</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
    </head>

    <body class="body" onload="addJsClass();">
        <div id="navigation">
            <ul>
                <li>
                    <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                        <a href="../guide/index.html" class="button">Table of contents</a>
                        <div id="nav-summary-childs" style="display:none;">
                            
                            <div class="toc-item" style="margin-left:0"><a href="#introduction"><strong>1</strong><span>Introduction</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#configuration"><strong>2</strong><span>Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#mapping"><strong>3</strong><span>Mapping</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#indexing"><strong>4</strong><span>Indexing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#searching"><strong>5</strong><span>Searching</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#admin"><strong>6</strong><span>Admin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#lowLevelAPI"><strong>7</strong><span>Low level API</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#example"><strong>8</strong><span>Example</span></a></div>
                            
                        </div>
                    </div>
                </li>
                <li class="separator selected">
                    <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
                </li>
            </ul>
        </div>
        <div id="header">
            <div class="images clearfix">
                
                
            </div>
            <p>The revived Elasticsearch plugin for Grails.</p>
        </div>


        <table id="colset" border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td id="col1">
                    <div id="main" class="corner-all">

                        <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                        <div class="project">
                            <h1>ElasticSearch Grails Plugin - Reference Documentation</h1>
                            <p><strong>Authors:</strong> Noam Y. Tenne, Manuarii Stein, Stephane Maldini, Serge P. Nekoval, Marcos Carceles</p>
                            <p><strong>Version:</strong> 0.0.4.5</p>
                            
                        </div>

                        
                        <div id="table-of-content">
                            <h2>Table of Contents</h2>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#introduction"><strong>1</strong><span>Introduction</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#features"><strong>1.1</strong><span>Features</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#history"><strong>1.2</strong><span>History</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#configuration"><strong>2</strong><span>Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#mapping"><strong>3</strong><span>Mapping</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#quickStart"><strong>3.1</strong><span>QuickStart</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#classMapping"><strong>3.2</strong><span>Class Mapping</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#propertiesMapping"><strong>3.3</strong><span>Properties mapping</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#parentChild"><strong>3.3.1</strong><span>Parent-Child</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#geoPoint"><strong>3.3.2</strong><span>GeoPoint</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#alias"><strong>3.3.3</strong><span>Alias</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#dynamic"><strong>3.3.4</strong><span>Dynamic</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#searchableComponentReference"><strong>3.4</strong><span>Searchable Component-Reference</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#searchableReference"><strong>3.4.1</strong><span>Searchable Reference</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#searchableComponent"><strong>3.4.2</strong><span>Searchable Component</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#mappingMigrations"><strong>3.5</strong><span>Mapping Migrations</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#indexing"><strong>4</strong><span>Indexing</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#searching"><strong>5</strong><span>Searching</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#queryStrings"><strong>5.1</strong><span>Query Strings</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#queryClosure"><strong>5.2</strong><span>Query Closure</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#queryBuilder"><strong>5.3</strong><span>Query QueryBuilder</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#filterClosure"><strong>5.4</strong><span>Filter Closure</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#filterBuilder"><strong>5.5</strong><span>Filter FilterBuilder</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#highlighting"><strong>5.6</strong><span>Highlighting</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#sorting"><strong>5.7</strong><span>Sorting</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#geodistanceSorting"><strong>5.7.1</strong><span>geoDistanceSorting</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#admin"><strong>6</strong><span>Admin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#refresh"><strong>6.1</strong><span>Refresh</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#deleteIndex"><strong>6.2</strong><span>Delete Index</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#lowLevelAPI"><strong>7</strong><span>Low level API</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#example"><strong>8</strong><span>Example</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#twitter"><strong>8.1</strong><span>Tweets</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#theDomains"><strong>8.1.1</strong><span>The domains</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#theController"><strong>8.1.2</strong><span>The controller</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#geoDistanceSearch"><strong>8.2</strong><span>Geo Distance Search</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#geoDistanceDomains"><strong>8.2.1</strong><span>Domains</span></a></div>
                            
                            <div class="toc-item" style="margin-left:20px"><a href="#geoDistanceService"><strong>8.2.2</strong><span>Service Methods</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#parentChildExample"><strong>8.3</strong><span>Parent/Child mapping</span></a></div>
                            
                            <div style="clear:both" ></div>
                        </div>
                        
                        

<h1 id="introduction">1 Introduction</h1>
The ElasticSearch plugin intends to implement a simple integration with Grails of the Open Source Search Engine <a href="http://www.elasticsearch.org/" target="blank">ElasticSearch</a>,
which is based on Lucene and provide distributed capabilities.<p class="paragraph"/>The plugin focus on exposing Grails domain classes for the moment. It highly takes the existing <a href="http://grails.org/plugin/searchable" target="blank">Searchable Plugin</a> as
reference for its syntax and behavior.<p class="paragraph"/>Note that the plugin is still under development, so you may not be able to use all the features of ElasticSearch yet.<p class="paragraph"/>In addition to this document, you may want to read the official ElasticSearch documentation <a href="http://www.elasticsearch.org/guide/" target="blank">here</a>.



<h2 id="features">1.1 Features</h2>
<ul class="star">
<li>Maps domain classes to their corresponding index in ElasticSearch</li>
<li>Provides an ElasticSearch service for cross-domain searching</li>
<li>Injects domain class methods for specific domain searching, indexing and unindexing</li>
<li>Automatically mirrors any changes made through GORM to the index</li>
<li>Allow to use the Groovy Content Builder DSL for search queries</li>
<li>Support for term highlighting</li>
</ul><p class="paragraph"/>


<h2 id="history">1.2 History</h2>
<h4>History</h4>
<ul class="star">
<li>June 15, 2015</li>
<ul class="star">
<li>0.0.4.5</li>
<ul class="star">
<li>Add the ability to define property names that are excluded by default</li>
<li>Fix NPE</li>
<li>Add the attachment type</li>
</ul>
</ul>
<li>March 5, 2015</li>
<ul class="star">
<li>0.0.4.4</li>
<ul class="star">
<li>Upgrade to Elasticsearch-Groovy 1.4.4</li>
</ul>
</ul>
<li>February 22, 2015</li>
<ul class="star">
<li>0.0.4.3</li>
<ul class="star">
<li>Add mapping configuration support for '_all'</li>
<li>Fix issue with indexing nested GeoPoint</li>
<li>Add support for transient properties</li>
</ul>
</ul>
<li>February 10, 2015</li>
<ul class="star">
<li>0.0.4.2</li>
<ul class="star">
<li>Reduce severity of non-searchable property in index document when unmarshalling domain</li>
</ul>
</ul>
<li>February 03, 2015</li>
<ul class="star">
<li>0.0.4.1</li>
<ul class="star">
<li>Upgrade to Elasticsearch 1.4.2</li>
<li>Enable configuration of the number of replicas created per shard</li>
</ul>
</ul>
<li>January 28, 2015</li>
<ul class="star">
<li>0.0.4.0</li>
<ul class="star">
<li>Included Mapping migrations</li>
<li>Included read and write aliases to indices to deal with migrations on multinode deployments</li>
</ul>
</ul>
<li>December 14, 2014</li>
<ul class="star">
<li>0.0.3.8</li>
<ul class="star">
<li>Upgrade to ElasticSearch 1.4.1</li>
<li>Support the min_score query parameter.</li>
<li>Try to detect the MongoDB without using the plugin manager.</li>
</ul>
</ul>
<li>December 01, 2014</li>
<ul class="star">
<li>0.0.3.7</li>
<ul class="star">
<li>Create separate SimpleTypeConverter per-thread</li>
</ul>
</ul>
<li>November 06, 2014</li>
<ul class="star">
<li>0.0.3.6</li>
<ul class="star">
<li>Upgrade to ElasticSearch 1.4.0</li>
</ul>
</ul>
<li>October 28, 2014</li>
<ul class="star">
<li>0.0.3.5</li>
<ul class="star">
<li>Fix the bulk index query iteration.</li>
</ul>
</ul>
<li>October 14, 2014</li>
<ul class="star">
<li>0.0.3.4</li>
<ul class="star">
<li>Upgrade to latest version of ElasticSearch and remove the Groovy client dependency.</li>
</ul>
</ul>
<li>August 28, 2014</li>
<ul class="star">
<li>0.0.3.3</li>
<ul class="star">
<li>Configure a component field to act as an inner object instead of a nested object.</li>
</ul>
</ul>
<li>August 3, 2014</li>
<ul class="star">
<li>0.0.3.2</li>
<ul class="star">
<li>Add the ability to mark fields with aliases</li>
<li>Support ES client HTTP configuration parameters</li>
<li>Improve Hibernate 4 support</li>
</ul>
</ul>
<li>June 9, 2014</li>
<ul class="star">
<li>0.0.3.1</li>
<ul class="star">
<li>Upgrade to ElasticSearch 1.2.x</li>
<li>Add special treatment for MongoDB ObjectId data types</li>
<li>Return raw result objects when now class mapping is found</li>
<li>Fix integration-test NPE</li>
</ul>
</ul>
<li>May 25, 2014</li>
<ul class="star">
<li>0.0.3.0</li>
<ul class="star">
<li>Upgrade to Grails dependency 2.2.x</li>
<li>Upgrade to Grails runtime 2.3.x</li>
<li>Upgrade to ElasticSearch 1.x</li>
<li>Apply ElasticSearch 1.x compatibility fixes</li>
<li>Enable customization of index name types when mapping classes</li>
</ul>
</ul>
<li>May 15, 2014</li>
<ul class="star">
<li>0.0.2.6</li>
<ul class="star">
<li>Use 'grails.util.Holders' instead of ApplicationHolder</li>
</ul>
</ul>
<li>April 2, 2014</li>
<ul class="star">
<li>0.0.2.5</li>
<ul class="star">
<li>Start releasing the plugin as 'elasticsearch' instead of 'elasticsearch-gorm'</li>
<li>Fix NPE when marshalling JSONObject fields</li>
</ul>
</ul>
<li>March 24, 2014</li>
<ul class="star">
<li>0.0.2.4</li>
<ul class="star">
<li>GeoPoint mapping</li>
<li>Injected service now supports filters (e.g. geo_reference) and sort builders (e.g. for geo_distance sorting)</li>
<li>Marshalled date values are now with correct time zone</li>
<li>Removed dependency on Java 7</li>
<li>Fix support of BigDecimal</li>
<li>Searchable mapping property name and Elasticsearch plugin path are now configurable.</li>
</ul>
</ul>
<li>February 4, 2014</li>
<ul class="star">
<li>0.0.2.3 Bugfix release</li>
</ul>
<li>January 19, 2014</li>
<ul class="star">
<li>0.0.2.2 Bugfix release</li>
</ul>
<li>November 24, 2013</li>
<ul class="star">
<li>0.0.2.1 Bugfix release</li>
</ul>
<li>November 12, 2013</li>
<ul class="star">
<li>0.0.2 release</li>
</ul>
<li>November 2, 2013</li>
<ul class="star">
<li>initial 0.0.1 release</li>
</ul></ul><p class="paragraph"/><h4>Authors and Contributors</h4><p class="paragraph"/>Noam Y. Tenne,
Stefan Rother-Stübs (Dating Cafe),
Sven Kiesewetter (Dating Cafe),
Michael Schwartz (Dating Cafe)<p class="paragraph"/><h4>Authors and Contributors of the original plugin</h4><p class="paragraph"/>Manuarii Stein (doc4web consulting),
Stephane Maldini (doc4web consulting),
Serge P. Nekoval<p class="paragraph"/>Get the full and updated list of contributors on the <a href="https://github.com/noamt/elasticsearch-grails-plugin" target="blank">github</a> repository.<p class="paragraph"/><h4>License</h4><p class="paragraph"/><blockquote class="quote">
    Copyright 2013-2014 the original author or authors.<p class="paragraph"/>    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at<p class="paragraph"/>        http://www.apache.org/licenses/LICENSE-2.0<p class="paragraph"/>    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
</blockquote><p class="paragraph"/><h4>Previous work</h4><p class="paragraph"/>Graeme Rocher started the first draft which this plugin is based on.



<h1 id="configuration">2 Configuration</h1>
The plugin provide a default configuration, but you may add your own settings in your <strong class="bold">Config.groovy</strong> script.<p class="paragraph"/><h4>Client mode</h4>
You can set the plugin in 3 different modes, detailed on the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/java-api/current/" target="blank">official ElasticSearch doc</a>.
The mode is defined with the following config key:<p class="paragraph"/><div class="code"><pre>elasticSearch.client.mode = '&#60;mode&#62;'</pre></div><p class="paragraph"/><strong class="bold">Possible values:</strong>
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Value</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>node</td><td>The plugin create its own node and join the ElasticSearch cluster as a client node (<code>node.client = true</code>). This setting requires that you have an ElasticSearch instance running and available on your network (use the discovery feature)</td></tr><tr class="table-even"><td>dataNode</td><td>The plugin create its own node and join the ElasticSearch cluster as a node that can hold data. This setting requires that you have an ElasticSearch instance running and available on your network (use the discovery feature)</td></tr><tr class="table-odd"><td>local</td><td>The plugin create its own local (to the JVM) node. Does not require any running ElasticSearch instance. Useful for development or testing.</td></tr><tr class="table-even"><td>transport</td><td>The plugin create a transport client that will connect to a remote ElasticSearch instance without joining the cluster.</td></tr></table><p class="paragraph"/>"Transport" mode needs you to provide the host address and port. You can define one or multiple hosts with the following config key:
<div class="code"><pre>elasticSearch.client.hosts = &#91;
       &#91;host:'192.168.0.3', port:9300&#93;,
       &#91;host:'228.168.0.4', port:9300&#93;
&#93;</pre></div>
If no host is defined, <code>localhost:9300</code> will be used by the transport client.<p class="paragraph"/><h4>Mapping Migration properties</h4><p class="paragraph"/>Define the application's behaviour when a conflict is found while installing Elasticsearch mappings on startup. For a detailed explanation, see Mapping Migrations.
<ul class="star">
<li><code>elasticSearch.migration.strategy</code></li>
</ul><p class="paragraph"/>Defines the behaviour to follow if an error occurs on startup when the application is installing new mappings on ElasticSearch due to conflicting mappings.
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Possible value</th><th>Description</th></tr><tr class="table-odd"><td><code>'none'</code></td><td>No changes on the indices or mappings will happen, the merge problem will be logged and a MappingException will be thrown.</td></tr><tr class="table-even"><td><code>'delete'</code></td><td>The conflicting mapping will be deleted (along with all indexed content of that type) and replaced with a new mapping. Deleted content can be automatically reindexed on startup by using this in combination the <code>elasticSearch.bulkIndexOnStartup</code> config option</td></tr><tr class="table-odd"><td><code>'alias'</code></td><td>Applies <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">Elasticsearch recommended approach for migrating conflicting mappings</a>. A new numbered index will be created (<code>&#60;indexName&#62;_vX</code>) where new mappings will installed for all the types included on the original index. An Elasticsearch alias called <code>&#60;indexName&#62;</code> will point to the new index. As content won't be available on the new index, content can be automcatically reindexedon startup by using this in combination the <code>elasticSearch.bulkIndexOnStartup</code> config option. It is recommended to set <code>elasticSearch.aliasReplacesIndex</code> to deal with potential index/alias conflicts.</td></tr></table><p class="paragraph"/>The default is <code>'alias'</code>.
<ul class="star">
<li><code>elasticSearch.migration.aliasReplacesIndex</code></li>
</ul><p class="paragraph"/>Deals with a special conflict case using the <code>'alias'</code> strategy. When the <code>'alias'</code> migration strategy is chosen and there's a mapping conflict on an index, defines whether to replace the index with a versioned index (<code>&#60;indexName&#62;_vX</code>) and an alias (<code>&#60;indexName&#62;</code>). This is required when applying the alias strategy on top of existing indices for the first time as indices cannot be renamed (from <code>&#60;indexName&#62;</code> to <code>&#60;indexName&#62;_vX</code>) and an alias cannot exist with the same name as an index.
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Possible value</th><th>Description</th></tr><tr class="table-odd"><td><code>true</code></td><td>The index and it's content will be deleted and a versioned index and an alias will be created. Deleted content can be automatically reindexed on startup by using this in combination the <code>elasticSearch.bulkIndexOnStartup</code> config option</td></tr><tr class="table-even"><td><code>false</code></td><td>Falls back to the <code>'none'</code> strategy. Event will be logged and a MappingException will be thrown.</td></tr></table><p class="paragraph"/>The default is <code>true</code>.
<ul class="star">
<li><code>elasticSearch.migration.disableAliasChange</code></li>
</ul><p class="paragraph"/>In some cases the developer may prefer not to upgrade the alias to the new version of the index until some other tasks are performed. This allows them to disable automatically pointing the alias to a new version of the index when this is created. Aliases can be changed later on manually or programatically using <code>elasticSearchAdminService</code>
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Possible value</th><th>Description</th></tr><tr class="table-odd"><td><code>false</code></td><td>Standard behaviour</td></tr><tr class="table-even"><td><code>true</code></td><td>Prevents the aliases to be changed to point to a new index</td></tr></table><p class="paragraph"/>The default is <code>false</code>.<p class="paragraph"/>
<h4>Others properties</h4>
<ul class="star">
<li><code>elasticSearch.datastoreImpl</code></li>
</ul><p class="paragraph"/>Only required when enabling the auto-index feature.
This property specifies which GORM datastore implementation should be watched for storage events.
The value should be the name of the datastore bean as it is configured in the Spring context; some possible values:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Value</th><th>Description</th></tr><tr class="table-odd"><td>mongoDatastore</td><td>The name of the MongoDB datastore bean.</td></tr><tr class="table-even"><td>hibernateDatastore</td><td>The name of the Hibernate datastore bean.</td></tr></table>
<ul class="star">
<li><code>elasticSearch.bootstrap.config.file</code></li>
</ul><p class="paragraph"/>When using then plugin to construct a local node, the default Elasticsearch configuration is used by default.
If you use a modified Elasticsearch configuration, you can use this property to specify the location of the file (as an application resource).
<ul class="star">
<li><code>elasticSearch.bootstrap.transportSettings.file</code></li>
</ul><p class="paragraph"/>When choosing transport mode this configuration will be used to set up the TransportClient settings (used by some cloud providers).
<ul class="star">
<li><code>elasticSearch.client.transport.sniff</code></li>
</ul><p class="paragraph"/>Only usable in with a transport client.
Allows to sniff the rest of the cluster, and add those into its list of machines to use.
In this case, the ip addresses used will be the ones that the other nodes were started with (the “publish” address)
<ul class="star">
<li><code>elasticSearch.cluster.name</code></li>
</ul><p class="paragraph"/>The name of the cluster for the client to join.
<ul class="star">
<li><code>elasticSearch.date.formats</code></li>
</ul><p class="paragraph"/>List of date formats used by the JSON unmarshaller to parse any date field properly.
Note : future version of the plugin may change how formats are manipulated.
<ul class="star">
<li><code>elasticSearch.defaultExcludedProperties</code></li>
</ul><p class="paragraph"/>List of domain class properties to automatically ignore (will not be indexed) if their name match one of those.
This will apply to both the default-mapped domain class, with the static <code>searchable</code> property set to "true", and when using closure mapping.
To override this setting on a specific class, it can be added to the <code>only</code> property of the <code>searchable</code> closure.
<ul class="star">
<li><code>elasticSearch.disableAutoIndex</code></li>
</ul><p class="paragraph"/>A boolean determining if the plugin should reflect any database save/update/delete automatically on the indices.
Default to <code>false</code>.
<ul class="star">
<li><code>elasticSearch.bulkIndexOnStartup</code></li>
</ul><p class="paragraph"/>Determines whether the application should launch a bulk index operation upon startup.
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Possible value</th><th>Description</th></tr><tr class="table-odd"><td><code>false</code></td><td>No indexing will happen on startup.</td></tr><tr class="table-even"><td><code>true</code></td><td>All content will be indexed on startup.</td></tr><tr class="table-odd"><td><code>'deleted'</code></td><td>This value is related to the mapping migration strategy choosen. If any migration is required and any content is deleted due to it, on startup only indices and mappings lost will be indexed. More on Mapping Migrations.</td></tr></table>
Default to <code>true</code>.
<ul class="star">
<li><code>elasticSearch.index.name</code></li>
</ul><p class="paragraph"/>A string indicating which ElasticSearch index should be used.  If not present, will default to the package name of the domain in question.
<ul class="star">
<li><code>elasticSearch.index.compound_format</code></li>
</ul><p class="paragraph"/>Should the compound file format be used (boolean setting).
Set to <code>false</code> by default (really applicable for file system based index storage).
More details on this setting on the <a href="http://www.elasticsearch.org/guide/reference/index-modules/" target="blank">ElasticSearch Documentation</a>.
<ul class="star">
<li><code>elasticSearch.index.store.type</code></li>
</ul><p class="paragraph"/>Determine how the indices will be stored.
More details on the possible values on the <a href="http://www.elasticsearch.org/guide/reference/index-modules/store.html" target="blank">ElasticSearch Documentation</a>.
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Possible value</th><th>Description</th></tr><tr class="table-odd"><td>memory</td><td>Stores the index in memory. Useful for testing.</td></tr><tr class="table-even"><td>mmapfs</td><td>Stores the shard index on the file system (maps to Lucene MMapDirectory) using mmap.</td></tr><tr class="table-odd"><td>niofs</td><td>Stores the shard index on the file system (maps to Lucene NIOFSDirectory) and allows for multiple threads to read from the same file concurrently.</td></tr><tr class="table-even"><td>simplefs</td><td>Stores using a plain forward implementation of file system storage (maps to Lucene SimpleFsDirectory) using random access file.</td></tr></table>
<ul class="star">
<li><code>elasticSearch.index.numberOfReplicas</code></li>
</ul><p class="paragraph"/>Sets the number of replicas created for each shard of the index. If not present, will default to zero.
<ul class="star">
<li><code>elasticSearch.gateway.type</code></li>
</ul><p class="paragraph"/>Determine the gateway type to be used.
More details on the possible values are in the <a href="http://www.elasticsearch.org/guide/reference/modules/gateway/" target="blank">ElasticSearch Documentation</a>.
Using a setting of "none" (possibly in combination with index.store.type set to "memory") can be useful for tests.
<ul class="star">
<li><code>elasticSearch.maxBulkRequest</code></li>
</ul><p class="paragraph"/>Max number of requests to process at once.
Reduce this value if you have memory issue when indexing a big amount of data at once.
If this setting is not specified, 500 will be use by default.
<ul class="star">
<li><code>elasticSearch.path.data</code></li>
</ul><p class="paragraph"/>The location of the data files of each index / shard allocated on the node.
<ul class="star">
<li><code>elasticSearch.path.plugins</code></li>
</ul><p class="paragraph"/>The location of plugin files such as native scripts. Each plugin will be contained in a subdirectory.
<ul class="star">
<li><code>elasticSearch.searchableProperty.name</code></li>
</ul><p class="paragraph"/>The name of the ElasticSearch mapping configuration property that annotates domain classes. The default is 'searchable'.
<ul class="star">
<li><code>elasticSearch.includeTransients</code></li>
</ul><p class="paragraph"/>Whether to index and search all non excluded transient properties. All explicitly included transients in <code>only</code> will be indexed regardless.
Default is <code>false</code>.<p class="paragraph"/><h4>Default configuration script</h4>
Below is the default configuration loaded by the plugin (any of your settings in the Config.groovy script overwrite those).<p class="paragraph"/><div class="code"><pre>elasticSearch &#123;
  /&#42;&#42;
   &#42; Date formats used by the unmarshaller of the JSON responses
   &#42;/
  date.formats = &#91;<span class="java&#45;quote">"yyyy&#45;MM&#45;dd'T'HH:mm:ss'Z'"</span>&#93;<p class="paragraph"/>  /&#42;&#42;
   &#42; Hosts <span class="java&#45;keyword">for</span> remote ElasticSearch instances.
   &#42; Will only be used with the <span class="java&#45;quote">"transport"</span> client mode.
   &#42; If the client mode is set to <span class="java&#45;quote">"transport"</span> and no hosts are defined, &#91;<span class="java&#45;quote">"localhost"</span>, 9300&#93; will be used by <span class="java&#45;keyword">default</span>.
   &#42;/
  client.hosts = &#91;
          &#91;host:'localhost', port:9300&#93;
  &#93;<p class="paragraph"/>  /&#42;&#42;
   &#42; Default mapping property exclusions
   &#42;
   &#42; No properties matching the given names will be mapped by <span class="java&#45;keyword">default</span>
   &#42; ie, when using <span class="java&#45;quote">"searchable = <span class="java&#45;keyword">true</span>"</span>
   &#42;
   &#42; This does not apply <span class="java&#45;keyword">for</span> classes using mapping by closure
   &#42;/
  defaultExcludedProperties = &#91;<span class="java&#45;quote">"password"</span>&#93;<p class="paragraph"/>  /&#42;&#42;
   &#42; Determines <span class="java&#45;keyword">if</span> the plugin should reflect any database save/update/delete automatically
   &#42; on the ES instance. Default to <span class="java&#45;keyword">false</span>.
   &#42;/
  disableAutoIndex = <span class="java&#45;keyword">false</span><p class="paragraph"/>  /&#42;&#42;
   &#42; Should the database be indexed at startup.
   &#42;
   &#42; The value may be a <span class="java&#45;object">boolean</span> <span class="java&#45;keyword">true</span>|<span class="java&#45;keyword">false</span>.
   &#42; Indexing is always asynchronous (compared to Searchable plugin) and executed after BootStrap.groovy.
   &#42;/
  bulkIndexOnStartup = <span class="java&#45;keyword">true</span><p class="paragraph"/>  /&#42;&#42;
   &#42;  Max number of requests to process at once. Reduce <span class="java&#45;keyword">this</span> value <span class="java&#45;keyword">if</span> you have memory issue when indexing a big amount of data
   &#42;  at once. If <span class="java&#45;keyword">this</span> setting is not specified, 500 will be use by <span class="java&#45;keyword">default</span>.
   &#42;/
  maxBulkRequest = 500<p class="paragraph"/>
  /&#42;&#42;
   &#42; The name of the ElasticSearch mapping configuration property that annotates domain classes. The <span class="java&#45;keyword">default</span> is 'searchable'.
   &#42;/
  searchableProperty.name = 'searchable'
&#125;<p class="paragraph"/>environments &#123;
  development &#123;
    /&#42;&#42;
     &#42; Possible values : <span class="java&#45;quote">"local"</span>, <span class="java&#45;quote">"node"</span>, <span class="java&#45;quote">"dataNode"</span>, <span class="java&#45;quote">"transport"</span>
     &#42; If set to <span class="java&#45;keyword">null</span>, <span class="java&#45;quote">"node"</span> mode is used by <span class="java&#45;keyword">default</span>.
     &#42;/
    elasticSearch.client.mode = 'local'
  &#125;
  test &#123;
      elasticSearch &#123;
          client.mode = 'local'
          index.store.type = 'memory' // store local node in memory and not on disk
      &#125;
  &#125;
  production &#123;
    elasticSearch.client.mode = 'node'
  &#125;
&#125;</pre></div>



<h1 id="mapping">3 Mapping</h1>
From version 0.0.4.0 in addition to the indices generated by the plugin based on the domain objects package names or configuration, two new aliases are created for every index: <code>&#60;indexName&#62;_read</code> and <code>&#60;indexName&#62;_write</code>. These two aliases are used by the plugin to index and query from Elasticsearch and are needed to centralise the choice of index to use during mapping migrations when the <code>'alias'</code> strategy is used and there are multiple instances of the application.



<h2 id="quickStart">3.1 QuickStart</h2>
<h4>Default mapping</h4>
To declare a domain class to be searchable, the simplest way is to define the following static property in the code:
<div class="code"><pre><span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span></pre></div>
The plugin will generate a default mapping for each properties of the domain.<p class="paragraph"/><h4>Custom mapping</h4>
You can customize how each properties are mapped to the index using a closure. The syntax is similar to GORM's mapping DSL.
<div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
    // mapping DSL&#8230;
&#125;</pre></div>
See below for more details on the mapping DSL.<p class="paragraph"/><h4>Limit properties with only/except</h4>
<code>only</code> and <code>except</code> are used to limit the properties that are made searchable.
You may not define both except &#38; only settings at the same time.<p class="paragraph"/>The following code will only map the 'message' property, any others will be ignored.
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        only = 'message'
    &#125;
    <span class="java&#45;object">String</span> message
    <span class="java&#45;object">String</span> someUselessField
&#125;</pre></div><p class="paragraph"/>The following code will map all properties except the one specified.
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        except = 'someUselessField'
    &#125;
    <span class="java&#45;object">String</span> message
    <span class="java&#45;object">String</span> someUselessField
&#125;</pre></div><p class="paragraph"/>You can use a Collection to specify several properties.
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        except = &#91;'someUselessField', 'userName'&#93;
    &#125;
    <span class="java&#45;object">String</span> message
    <span class="java&#45;object">String</span> userName
    <span class="java&#45;object">String</span> someUselessField
&#125;</pre></div><p class="paragraph"/><blockquote class="note">The properties that are ignored will not be sent to ElasticSearch. It also means that when you will get back a domain
from ElasticSearch, some fields that are not supposed to be null, may still be null.</blockquote><p class="paragraph"/><h4>Including transients</h4><p class="paragraph"/>How the plugin manages transient properties is controlled by the <code>elasticSearch.includeTransients</code> configuration property. If this is set to <code>false</code> only transient properties explictly included in <code>only</code> will be mapped and searchable, if set to <code>true</code>, all domain class properties will be mapped, including <code>transients</code>.<p class="paragraph"/>The following are valid examples<p class="paragraph"/><div class="code"><pre>//assert grailsApplication.config.elasticSearch.includeTransients == <span class="java&#45;keyword">false</span>
class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName
    <span class="java&#45;object">String</span> getFullName() &#123;
        firstName + <span class="java&#45;quote">" "</span> + lastName
    &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'fullName'&#93;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        only = &#91;'fullName'&#93;
    &#125;
&#125;
// <span class="java&#45;keyword">new</span> Person(firstNameme: <span class="java&#45;quote">"Nikola"</span>, lastName: <span class="java&#45;quote">"Tesla"</span>)
// can be found using:
// def tesla = Person.search(<span class="java&#45;quote">"Nikola Tesla"</span>).searchResults.first()</pre></div><p class="paragraph"/><div class="code"><pre>//assert grailsApplication.config.elasticSearch.includeTransients == <span class="java&#45;keyword">true</span>
class Multiplication &#123;
    <span class="java&#45;object">int</span> opA
    <span class="java&#45;object">int</span> opB
    <span class="java&#45;object">int</span> getResult() &#123;
        opA &#42; opB
    &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'result'&#93;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span>
&#125;
// <span class="java&#45;keyword">new</span> Multiplication(opA: 2, opB: 3)
// can be found using:
// def multiplication = Multiplication.search(<span class="java&#45;quote">"2"</span>).searchResults.first()
// def multiplication = Multiplication.search(<span class="java&#45;quote">"3"</span>).searchResults.first()
// def multiplication = Multiplication.search(<span class="java&#45;quote">"6"</span>).searchResults.first()</pre></div><p class="paragraph"/><blockquote class="note">
From the examples above, once the domain object is found, its transient values will be calculated from the information stored on ElasticSearch: <code>multiplication.result == 6</code>, but <code>tesla.fullName == "null null"</code>, as firstName and lastName where not indexed. This behaviour can be prevented by creating convenient setters for the transient properties.
</blockquote><p class="paragraph"/><h4>Transients and collections</h4><p class="paragraph"/>When transient properties are collections the only way the plugin can define the correct ElasticSearch mapping during boot is if the element types are explicitly defined on the grails domain object. For instances of <code>Collection</code> this can be achieved by defining its type on the <code>hasMany</code> property (otherwise the ElasticSearch type will be defined as <code>object</code>). This is not required for arrays.<p class="paragraph"/>Some valid examples:
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;object">String</span> message
    List getHashtags() &#123; &#8230; &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'hashtags'&#93;
    <span class="java&#45;keyword">static</span> hasMany = &#91;hashtags: <span class="java&#45;object">String</span>&#93;
    <span class="java&#45;keyword">static</span> searchable = &#123;only = 'hashtags' &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class FamilyGuy &#123;
    <span class="java&#45;object">String</span> wife
    <span class="java&#45;object">String</span> son
    <span class="java&#45;object">String</span> daughter
    <span class="java&#45;object">String</span> baby
    <span class="java&#45;object">String</span>&#91;&#93; getRelatives() &#123; &#8230; &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'relatives'&#93;
    <span class="java&#45;keyword">static</span> searchable = &#123; only = 'relatives' &#125;
&#125;</pre></div>


<h2 id="classMapping">3.2 Class Mapping</h2>
<h4>root</h4>
Determine if the domain class will have its own index or not. Take a boolean as parameter, and is set to <code>true</code> by default.
<div class="code"><pre>class Preference &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        root <span class="java&#45;keyword">false</span>
    &#125;
    // &#8230;
&#125;<p class="paragraph"/>class Tag &#123;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span>
    // &#8230;
&#125;<p class="paragraph"/>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        message boost:2.0
    &#125;
    // &#8230;
&#125;</pre></div>
In this code, the classes <code>Tweet</code> and <code>Tag</code> are going to have their own index. The class <code>Preference</code> will not.
It also mean that any search request will never return a Preference-type hit. The dynamic method <code>search</code> will not be
injected in the <code>Preference</code> domain class.
The domains not root-mapped can still be considered searchable, as they can be components of another domain which is root-mapped.
For example, considered the following domain:
<div class="code"><pre>class User &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        userPreferences component:<span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    Preference userPreferences
&#125;</pre></div>
When searching, any matches in the <code>userPreferences</code> property will be considered as a <code>User</code> match.<p class="paragraph"/><h4>all</h4>
Set default analyzer for all domain class fields.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
  all = &#91;analyzer: 'russian_morphology'&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
  all = <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>When disabling the all field, it is a good practice to set index.query.default_field to a different value (for example, if you have a main 'message' field in your data, set it to message).



<h2 id="propertiesMapping">3.3 Properties mapping</h2>
You can customize the mapping for each domain properties using the closure mapping.
The syntax is simple:
<div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
    propertyName option1:value, option2:value, &#8230;
&#125;</pre></div><p class="paragraph"/><h4>Available options</h4><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Option name</strong></th><th>Values</th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>boost</td><td>Number</td><td>A decimal boost value. With a positive value, promotes search results for hits in this property; with a negative value, demotes search results that hit this property.</td></tr><tr class="table-even"><td><a href="../guide/single.html#searchableComponent" class="guide">component</a></td><td><code>true</code>, <code>false</code></td><td>To use only on domain (or collection of domains), make the property a searchable component.</td></tr><tr class="table-odd"><td>converter</td><td>A <code>Class</code></td><td>A <code>Class</code> to use as a converter during the marshalling/unmarshalling process for that peculiar property. That class must extends the <code>PropertyEditorSupport</code> java class.</td></tr><tr class="table-even"><td>excludeFromAll</td><td><code>true</code>, <code>false</code></td><td>determines if the property is to append in the <code>"_all"</code> field. Default to <code>true</code>.</td></tr><tr class="table-odd"><td>index</td><td><code>"no"</code>, <code>"not_analyzed"</code>, <code>"analyzed"</code>.</td><td>How or if the property is made into searchable element. One of <code>"no"</code>, <code>"not_analyzed"</code> or <code>"analyzed"</code>.</td></tr><tr class="table-even"><td><a href="../guide/single.html#searchableReference" class="guide">reference</a></td><td><code>true</code>, <code>false</code></td><td>To use only on domain (or collection of domains), make the property a searchable reference.</td></tr><tr class="table-odd"><td><a href="../guide/single.html#parentChild" class="guide">parent</a></td><td><code>true</code>, <code>false</code></td><td>A boolean value to be used in conjunction with the <code>reference</code> or <code>component</code> property . Set to <code>true</code> if the referenced field should be mapped as the parent of this document. Default set to <code>false</code>.</td></tr><tr class="table-even"><td>multi_field</td><td><code>true</code>, <code>false</code></td><td>A boolean value. Maps the value of the field twice; Once with it being analyzed, and once with it being not_analyzed under untouched. Default set to <code>false</code>.</td></tr><tr class="table-odd"><td><a href="../guide/single.html#geoPoint" class="guide">geoPoint</a></td><td><code>true</code>, <code>false</code></td><td>Maps the field to a geo_point. Default: <code>false</code></td></tr><tr class="table-even"><td><a href="../guide/single.html#alias" class="guide">alias</a></td><td>String</td><td>A string value.  The field noted with this parameter will be duplicated to an alias</td></tr><tr class="table-odd"><td><a href="../guide/single.html#dynamic" class="guide">dynamic</a></td><td><code>true</code>, <code>false</code></td><td>Only available for String properties. Determines whether this field should be dynamicly mapped by elasticsearch.</td></tr></table>



<h2 id="parentChild">3.3.1 Parent-Child</h2>
To map a parent/child relationship, the child element must either contain the parent element as a component or reference it as a referenced document.
This component must be mapped as a parent in the child element.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class ParentElement &#123;
…
&#125;<p class="paragraph"/>class EmbeddingChild &#123;
    ParentElement parentElement<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        parentElement parent: <span class="java&#45;keyword">true</span>, component: <span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>class ReferencingChild &#123;
    ParentElement parentElement<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        parentElement parent: <span class="java&#45;keyword">true</span>, reference: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>


<h2 id="geoPoint">3.3.2 GeoPoint</h2>
A geographic location can be mapped to a geo_point. The field for the longitude has to be named <code>lon</code> and the field for the latitude has to be named <code>lat</code><p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class GeoPoint &#123;<p class="paragraph"/>    <span class="java&#45;object">Double</span> lat
    <span class="java&#45;object">Double</span> lon<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        root <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>class Building &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    GeoPoint location<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        location geoPoint: <span class="java&#45;keyword">true</span>, component: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div>



<h2 id="alias">3.3.3 Alias</h2>
A field can be aliased.  This is useful in situations where another service may expect certain tags.
For example, <a href="http://www.elasticsearch.org/overview/kibana/" target="blank">Kibana</a> uses an <code>&#64;timestamp</code> field to filter
report records by date.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class Session &#123;<p class="paragraph"/>    Date loginTime<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        loginTime alias:'@timestamp'
    &#125;
&#125;</pre></div>



<h2 id="dynamic">3.3.4 Dynamic</h2>
Elasticsearch can map field contents as dynamic objects.
This is especially useful if you store JSON Strings in your database and want to make those objects searchable in elasticsearch.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class Session &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> jsonData<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        dynamic: <span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>Session session = <span class="java&#45;keyword">new</span> Session()
session.jsonData = (&#91;foo: 'bar'&#93; as JSON).toString()</pre></div><p class="paragraph"/>The default mapping would make the jsonData field an escaped String field and
a search for jsonData.foo = bar would result in no result.
With dynamic mapping enabled for this field, we enable JSON handling of this field and tell elasticsearch to map this field dynamicly.
The result is that a search for jsonData.foo=bar would result in a search hit.
Attention: This will only work on String fields and will result in an error if the String is no valid json


<h2 id="searchableComponentReference">3.4 Searchable Component-Reference</h2>
The plugin support a similar searchable-component &#38; searchable-reference behavior from Compass
when you are dealing with domain association.
See below to find out about the difference between both mapping modes.



<h2 id="searchableReference">3.4.1 Searchable Reference</h2>
The searchable-reference mapping mode is the default mode used for association, and requires the
searchable class of the association to be root-mapped in order to have its own index.
With this mode, the associated domains are not completely marshalled in the resulting JSON document:
only the id and the type of the instances are kept.
When the document is retrieved from the index, the plugin will automatically rebuild the association from the
indices using the stored id.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>class MyDomain &#123;
    // odom is an association with the OtherDomain class, set as a reference
    OtherDomain odom<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        odom reference:<span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>// The OtherDomain definition, with <span class="java&#45;keyword">default</span> searchable configuration
class OtherDomain &#123;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span><p class="paragraph"/>    <span class="java&#45;object">String</span> field1 = <span class="java&#45;quote">"val1"</span>
    <span class="java&#45;object">String</span> field2 = <span class="java&#45;quote">"val2"</span>
    <span class="java&#45;object">String</span> field3 = <span class="java&#45;quote">"val3"</span>
    <span class="java&#45;object">String</span> field4 = <span class="java&#45;quote">"val4"</span>
&#125;</pre></div><p class="paragraph"/>When indexing an instance of MyDomain, the resulting JSON documents will be sent to ElasticSearch:
<div class="code"><pre>&#123;
    <span class="java&#45;quote">"mydomain"</span>: &#123;
        <span class="java&#45;quote">"_id"</span>:1,
        <span class="java&#45;quote">"odom"</span>: &#123; <span class="java&#45;quote">"id"</span>:1 &#125;
    &#125;
&#125;<p class="paragraph"/>&#123;
    <span class="java&#45;quote">"otherdomain"</span>: &#123;
        <span class="java&#45;quote">"_id"</span>:1,
        <span class="java&#45;quote">"field1"</span>:<span class="java&#45;quote">"val1"</span>,
        <span class="java&#45;quote">"field2"</span>:<span class="java&#45;quote">"val2"</span>,
        <span class="java&#45;quote">"field3"</span>:<span class="java&#45;quote">"val3"</span>,
        <span class="java&#45;quote">"field4"</span>:<span class="java&#45;quote">"val4"</span>
    &#125;
&#125;</pre></div>



<h2 id="searchableComponent">3.4.2 Searchable Component</h2>
The searchable-component mapping mode must be explicitly set, and does not require the
searchable class of the association to be root-mapped.
With this mode, the associated domains are nested in the parent document.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>class MyDomain &#123;
    // odom is an association with the OtherDomain class, set as a reference
    OtherDomain odom<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        odom component:<span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>// The OtherDomain definition, with <span class="java&#45;keyword">default</span> searchable configuration
class OtherDomain &#123;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span><p class="paragraph"/>    <span class="java&#45;object">String</span> field1 = <span class="java&#45;quote">"val1"</span>
    <span class="java&#45;object">String</span> field2 = <span class="java&#45;quote">"val2"</span>
    <span class="java&#45;object">String</span> field3 = <span class="java&#45;quote">"val3"</span>
    <span class="java&#45;object">String</span> field4 = <span class="java&#45;quote">"val4"</span>
&#125;</pre></div><p class="paragraph"/>When indexing an instance of MyDomain, the resulting JSON document will be sent to ElasticSearch:
<div class="code"><pre>&#123;
    <span class="java&#45;quote">"mydomain"</span>: &#123;
        <span class="java&#45;quote">"_id"</span>:1,
        <span class="java&#45;quote">"odom"</span>: &#123;
            <span class="java&#45;quote">"_id"</span>:1,
            <span class="java&#45;quote">"field1"</span>:<span class="java&#45;quote">"val1"</span>,
            <span class="java&#45;quote">"field2"</span>:<span class="java&#45;quote">"val2"</span>,
            <span class="java&#45;quote">"field3"</span>:<span class="java&#45;quote">"val3"</span>,
            <span class="java&#45;quote">"field4"</span>:<span class="java&#45;quote">"val4"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>If you'd rather that the reference object be mapped with type 'inner' rather than the default 'nested', set the 'component' key with a value of 'inner' rather than 'true':
<div class="code"><pre>class MyDomain &#123;
    // odom is an association with the OtherDomain class, set as a reference
    OtherDomain odom<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        odom component: '<span class="java&#45;keyword">inner</span>'
    &#125;
&#125;</pre></div>


<h2 id="mappingMigrations">3.5 Mapping Migrations</h2>
During the application startup the application will attempt to create the needed indices on Elasticsearch and create the type mappings defined by the user. If these indices and mappings already existed on the Elasticsearch cluster (ie. an older verion of the application was running against it) and the new mapping definitions differ with the existing ones there's the potential for a Mapping conflict. This section describes how to configure the application to deal with this scenario.<p class="paragraph"/>It is important to highlight that not all type mapping changes will result on a conflict. Ie. adding a new field to a mapping does not result in a conflict whilst changing a property from component:'inner' to nested or viceversa, will. These strategies will only be needed and applied when a <strong class="bold">conflicting</strong> mapping is found.<p class="paragraph"/><h3>Migration Strategies</h3>
The migration strategy is defined by the <code>elasticSearch.migration.strategy</code> configuration property and it accepts three values:
<ul class="minus">
<li><code>'none'</code></li>
<li><code>'delete'</code></li>
<li><code>'alias'</code></li>
</ul><p class="paragraph"/>The default strategy is <code>'alias'</code> as it is the only strategy that can achieve zero-downtime migrations and thus <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">recommended by Elasticsearch</a><p class="paragraph"/>These values are described on more detail further ahead<p class="paragraph"/><h4>Migration Strategy 'none'</h4><p class="paragraph"/>This option keeps the original behaviour the plugin used before the Migration Strategies were implemented. When a Mapping Merge conflict id identified the event will be logged and an Exception will be logged.
It will be responsability for the application administrator to manually fix the problem.
This configuration was left as a backwards compatibility and it will prevent the application from booting successfully, therefore we <strong class="bold">discourage teams from using this option</strong>.<p class="paragraph"/><h4>Migration Strategy 'delete'</h4><p class="paragraph"/>When choosing this option, when a conflict occurs installing  mapping, the application will delete the existing mapping for the type, alongside with all content indexed on that index and type and recreated the mapping. There are a couple of important details on this information:
<ul class="minus">
<li>Only documents indexed on the conflicting mapping will be deleted, any other document on a different mapping on the same (or other) index will remain untouched.</li>
<li>Deleted documents can be automatically reindexed on startup by using the <code>elasticSearch.bulkIndexOnStartup</code> configuration property (See below)</li>
<li>Using this configuration there will always be a time window (between deletion and reindexation) where documents can't be found by search, therefore this option cannot achieve a <strong class="bold">zero-downtime</strong> deployment</li>
</ul><p class="paragraph"/>See Dealing with deleted content below for more details on automatic indexing.<p class="paragraph"/><h4>Migration Strategy 'alias'</h4><p class="paragraph"/>This is the migration strategy <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">recommended by Elasticsearch</a>.<p class="paragraph"/>To better understand this strategy we will describe a typical <code>'alias'</code> migration.<p class="paragraph"/><div class="code"><pre>Elasticsearch contains
  index 'myapplication.store_v27' with types 'car' and 'motorbike'
  alias 'myapplication.store' pointing to 'myapplication.store_v27'
  'myapplication.store_v27/car' contains 520 documents
  'myapplication.store_v27/motorbike' contains 12 documents
  index 'myapplication.admin_v0' with type 'quote'
  alias 'myapplication.admin' pointing to 'myapplication.admin_v0'
  'myapplication.admin_v0/quote' contains 3200 documents<p class="paragraph"/>The application is configured to use indexes based on <span class="java&#45;keyword">package</span> names 'myapplication.store' and 'myapplication.admin'
(which as we already explained are actually aliases that point to versioned indices)<p class="paragraph"/>The team introduced a change on the Car domain that results in a conflict on the 'car' mapping<p class="paragraph"/>The application starts up
    Tries to install the mapping <span class="java&#45;keyword">for</span> 'motorbike', it detects the conflict
    Creates a <span class="java&#45;keyword">new</span> index called 'myapplication.store_v28'
    Creates mappings 'myapplication.store_v28/car' and 'myapplication.store_v28/motorbike'
    Points all indexing requests <span class="java&#45;keyword">for</span> Car and Motorbike to the <span class="java&#45;keyword">new</span> index, <span class="java&#45;keyword">while</span> queries still happen on 'myapplication.store'
On Boostrap (bulkIndexOnStartup)
    It indexes 520 cars into 'myapplication.store_v28/car'
    It indexes 12 motorbikes into 'myapplication.store_v28/motorbike'
    Switches the 'myapplication.store' alias to point to 'myapplication.store_v28'
    Now all cars are indexed according to the <span class="java&#45;keyword">new</span> mapping
    Now all motorbikes are indexed according to the <span class="java&#45;keyword">new</span> mapping</pre></div><p class="paragraph"/><blockquote class="note">
All content can be queried at all times, during Bootstrap bulkIndexOnStartup content will be retrieved from the old index.
</blockquote><p class="paragraph"/><blockquote class="warning">
Eventhough there wasn't a conflict on 'car', all cars needed to be reindexed as they lived on the same index.
</blockquote><p class="paragraph"/>There are three potential scenarios when using the <code>'alias'</code> strategy:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Scenario</th><th>Behaviour</th></tr><tr class="table-odd"><td>The index (ie. 'myapplication.store') does not exist</td><td>On this case there is not possibility of conflicts, as no previous mapping exist. However the application will behave slightly different than on the other to scenarios. Instead of creating the index (ie. 'myapplication.store'), it will create version 0 of it (ie. 'myapplication.store_v0') and an alias pointint to it. This is to facilitate the creation of future versions in case of conflict.</td></tr><tr class="table-even"><td>Alias exists pointing to a version (ie. 'myapplication.store' -&#62; 'myapplication.store_v27')</td><td>If there's a conflict on a mapping on the index, it will create a new version (ie. 'myapplication.store_v28'), reindex the content or not depending on the value of the <code>elasticSearch.bulkIndexOnStartup</code> configuration property and point the alias to the new version once done.</td></tr><tr class="table-odd"><td>Index already exists (ie. 'myapplication.store')</td><td>Elasticsearch cannot rename an index or create an alias with the same name as an index. The two alternatives here are to delete the index or fail the migration. This is controlled by the <code>elasticSearch.migration.aliasReplacesIndex</code> configuration property, if set to true, it will delete the index and proceed the same way as when the index did not exist. The deleted documents will be reindexed or not depending on the value of the <code>elasticSearch.bulkIndexOnStartup</code>. <strong class="bold">This is the only scenario where there is content loss/downtime using the <code>'alias'</code> strategy.</strong></td></tr></table><p class="paragraph"/>In the case you wanted to create a new version of an index, but not change where the alias points to (ie. for testing or if you wanted to perform extra tasks on the index before updating the alias), the <code>elasticSearch.migration.disableAliasChange</code> configuration property can be used<p class="paragraph"/><blockquote class="note">
Aliases will only point to the new version of the index once all content is reindexed (if chosen to). Meanwhile, all index requests, either by <code>elasticSearchService</code> or using dynamic finders will go to the new version of the index, whilst queries will go to the old version of the index.
</blockquote><p class="paragraph"/>See Dealing with deleted content below for more details on automatic indexing.<p class="paragraph"/><h4>Dealing with deleted content</h4><p class="paragraph"/>Using the <code>'delete'</code> or <code>'alias'</code> strategy may lead to deleting content stored on Elasticsearch. This content can be automatically reindexed using the <code>elasticSearch.bulkIndexOnStartup</code>. The duration of this process will depend on the amount of content to index.<p class="paragraph"/>When this property is set to <code>true</code> all content will be deleted. When set to <code>'deleted'</code> only the domain classes which documents where deleted will be indexed. In either case, when using the <code>'alias'</code> strategy, once all content is indexed all aliases will point to the latest version of the index.


<h1 id="indexing">4 Indexing</h1>
With its default configuration (with the <code>disableAutoIndex</code> configuration key set to <code>false</code>), the plugin is indexing
automatically any searchable domains when GORM/Hibernate do a save or an update in the database.
It also delete automatically from the index any document corresponding to a domain that is deleted from the database.
You normally shouldn't have to worry about indexing, but sometimes you may have to do it by yourself, for example on dirty
domain object that you may not want to save right now.<p class="paragraph"/>The plugin is providing a few injected methods in the domain or in the <code>ElasticSearchService</code> to allow that.<p class="paragraph"/><h3>Index examples</h3>
<div class="code"><pre>// Index all searchable instances
elasticSearchService.index()<p class="paragraph"/>// Index a specific domain instance
MyDomain md = <span class="java&#45;keyword">new</span> MyDomain(value:'that')
md.save()
elasticSearchService.index(md)<p class="paragraph"/>// Index a collection of domain instances
def ds = &#91;<span class="java&#45;keyword">new</span> MyDomain(value:'that'), <span class="java&#45;keyword">new</span> MyOtherDomain(name:'<span class="java&#45;keyword">this</span>'), <span class="java&#45;keyword">new</span> MyDomain(value:'thatagain')&#93;
ds&#42;.save()
elasticSearchService.index(ds)<p class="paragraph"/>// Index all instances of the specified domain class
elasticSearchService.index(MyDomain)
elasticSearchService.index(class:MyDomain)
elasticSearchService.index(MyDomain, MyOtherDomain)
elasticSearchService.index(&#91;MyDomain, MyOtherDomain&#93;)</pre></div><p class="paragraph"/><h3>Unindex examples</h3>
<div class="code"><pre>// Unindex all searchable instances
elasticSearchService.unindex()<p class="paragraph"/>// Unindex a specific domain instance
MyDomain md = <span class="java&#45;keyword">new</span> MyDomain(value:'that')
md.save()
elasticSearchService.unindex(md)<p class="paragraph"/>// Unindex a collection of domain instances
def ds = &#91;<span class="java&#45;keyword">new</span> MyDomain(value:'that'), <span class="java&#45;keyword">new</span> MyOtherDomain(name:'<span class="java&#45;keyword">this</span>'), <span class="java&#45;keyword">new</span> MyDomain(value:'thatagain')&#93;
ds&#42;.save()
elasticSearchService.unindex(ds)<p class="paragraph"/>// Unindex all instances of the specified domain class
elasticSearchService.unindex(MyDomain)
elasticSearchService.unindex(class:MyDomain)
elasticSearchService.unindex(MyDomain, MyOtherDomain)
elasticSearchService.unindex(&#91;MyDomain, MyOtherDomain&#93;)</pre></div>


<h1 id="searching">5 Searching</h1>
The plugin provides 2 ways to send search requests.
<ul class="star">
<li>You can use the <code>elasticSearchService</code> and its public <code>search</code> method for cross-domain searching, meaning that ElasticSearch</li>
</ul><p class="paragraph"/>may analyze multiple indices and return hits of different types (=different domains).
<div class="code"><pre>def res = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
// 'res' search results may contains multiple types of results</pre></div>
<ul class="star">
<li>You can use the injected dynamic method in the domain for domain-specific searching.</li>
</ul><p class="paragraph"/><div class="code"><pre>def res = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
// 'res' search results contains only Tweet instances</pre></div><p class="paragraph"/>These search methods return a <code>Map</code> containing 3 entries:
<ul class="star">
<li>a <code>total</code> entry, representing the total number of hits found</li>
<li>a <code>searchResults</code> entry, containing the hits</li>
<li>a <code>scores</code> entry, containing the hits scores</li>
</ul><p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def res = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
println <span class="java&#45;quote">"Found $&#123;res.total&#125; result(s)"</span>
res.searchResults.each &#123;
    println it.message
&#125;<p class="paragraph"/>def res = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
println <span class="java&#45;quote">"Found $&#123;res.total&#125; result(s)"</span>
res.searchResults.each &#123;
    <span class="java&#45;keyword">if</span>(it <span class="java&#45;keyword">instanceof</span> Tweet) &#123;
        println it.message
    &#125; <span class="java&#45;keyword">else</span> &#123;
        println it.toString()
    &#125;
&#125;</pre></div><p class="paragraph"/>If you're willing to retrieve only the number of hits for a peculiar query, you can use the <code>countHits()</code>
method. It will only return an <code>Integer</code> representing the total hits matching your query.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def res = Tweet.countHits(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
println <span class="java&#45;quote">"Found $&#123;res&#125; result(s)"</span><p class="paragraph"/>def res = elasticSearchService.countHits(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;indices:'test'&#93;)
println <span class="java&#45;quote">"Found $&#123;res&#125; result(s)"</span></pre></div>


<h2 id="queryStrings">5.1 Query Strings</h2>
The search method injected in the domain or the <code>ElasticSearchService</code> has multiple signatures available.
You can pass it a simple <code>String</code> to compute your search request. That string will be parsed by the <strong class="bold">Lucene query parser</strong>
so feel free to use its syntax to do more specific search query.<p class="paragraph"/>You can find out about the syntax on the <a href="http://lucene.apache.org/java/3_0_3/queryparsersyntax.html" target="blank">Apache Lucene website</a>.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def results = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>)
def resultsTweets = Tweet.search(<span class="java&#45;quote">"message:$&#123;params.query&#125;"</span>)</pre></div>



<h2 id="queryClosure">5.2 Query Closure</h2>
You can use the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/groovy-api/current/search.html" target="blank">Groovy Query DSL</a> to build your search query as a <code>Closure</code>.
The format of the search <code>Closure</code> follow the same JSON syntax as the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search.html" target="blank">ElasticSearch REST API</a>
and the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/java-api/current/query-dsl-queries.html" target="blank">Java Query DSL</a>.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>def result = elasticSearchService.search(searchType:'dfs_query_and_fetch') &#123;
  bool &#123;
      must &#123;
          query_string(query: params.query)
      &#125;
      <span class="java&#45;keyword">if</span> (params.firstname) &#123;
          must &#123;
              term(firstname: params.firstname)
          &#125;
      &#125;
  &#125;
&#125;</pre></div>


<h2 id="queryBuilder">5.3 Query QueryBuilder</h2>
A <code>QueryBuilder</code> can be passed to the search method.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>QueryBuilder query = QueryBuilders.matchAllQuery()
def result = elasticSearchService.search(query)</pre></div>


<h2 id="filterClosure">5.4 Filter Closure</h2>
A filter closure can be passed as a second argument after the search closure to the search method.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>def result = elasticSearchService.search(
    &#91;indices: Building, types: Building, sort: sortBuilder&#93;,
    <span class="java&#45;keyword">null</span> as Closure,
    &#123;
        geo_distance(
            'distance': '5km',
            'location': &#91;lat: 48.141, lon: 11.57&#93;
        )
    &#125;)</pre></div>



<h2 id="filterBuilder">5.5 Filter FilterBuilder</h2>
A <code>FilterBuilder</code> filter can be passed as a second argument after the search parameter to the search method.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>FilterBuilder filter = FilterBuilders.rangeFilter(<span class="java&#45;quote">"price"</span>).gte(1.99).lte(2.3)
def result = elasticSearchService.search(
    &#91;indices: Building, types: Building, sort: sortBuilder&#93;,
    <span class="java&#45;keyword">null</span> as Closure,
    filter)</pre></div>



<h2 id="highlighting">5.6 Highlighting</h2>
The search method support highlighting: automatic wrapping of the matching terms in the search results with
HTML/XML/Whatever tags.
You can activate this with a <code>Closure</code> containing the highlight settings in the search method <code>highlight</code> parameter.
The format of the <code>Closure</code> for defining the highlight settings is the same as the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-highlighting.html" target="blank">ElasticSearch REST API</a>.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>// Define the pre &#38; post tag that will wrap each term matched in the document.
def highlighter = &#123;
  field 'message'
  field 'tags.name'
  preTags '&#60;strong&#62;'
  postTags '&#60;/strong&#62;'
&#125;<p class="paragraph"/>def results = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: highlightSettings&#93;)</pre></div><p class="paragraph"/><h3>Highlight results</h3>
If a search result is found, the <code>search</code> method will add a <code>highlight</code> entry in the map result.
That entry contains a <code>List</code> with every highlighted fragments/fields found for each hit.<p class="paragraph"/><div class="code"><pre>def results = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: &#123; field 'message' &#125;&#93;)
def highlighted = results.highlight<p class="paragraph"/>results?.searchResults?.eachWithIndex &#123; hit, index &#45;&#62;
    // Retrieve the 'message' field fragments <span class="java&#45;keyword">for</span> the current hits
    def fragments = highlighted&#91;index&#93;.message?.fragments<p class="paragraph"/>    // Print the fragment
    println fragments?.size() ? fragments&#91;0&#93; : ''
&#125;</pre></div><p class="paragraph"/><h3>Highlighted fields</h3>
To determine which fields are to be processed by ElasticSearch, use the <code>field</code> setting.
You can call the <code>field</code> setting as many time as you want to add any field.<p class="paragraph"/><strong class="bold">Signature</strong>
<div class="code"><pre>field &#60;fieldName&#62;&#91;, &#60;fragmentSize&#62;&#91;, &#60;numberOfFragment&#62;&#93;&#93;</pre></div><p class="paragraph"/><strong class="bold">Examples</strong>
<div class="code"><pre>def highlightSettings = &#123;
    field 'message'                    // Add the 'message' field in the highlighted fields list
    field 'tags.name'                  // Add the 'name' field contained in the 'tags' field of
                                       // the document in the highlighted fields list
    field 'thatAwesomeField', 0, 20    // Add the 'thatAwesomeField' field with
                                       // some values fixed <span class="java&#45;keyword">for</span> fragmentSize and numberOfFragment parameters
&#125;<p class="paragraph"/>def highlightSettings2 = &#123;
    field '_all'                       // Add the special '_all' field in the highlighted fields list
&#125;<p class="paragraph"/>def results = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: highlightSettings&#93;)
def results2 = Tweet.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>, &#91;highlight: highlightSettings2&#93;)</pre></div><p class="paragraph"/><h3>Highlighting tags</h3>
By default, ElasticSearch will use emphasis tag "<code>&#60;em&#62;...&#60;/em&#62;</code>" to wrap the matching text.
You can customize the tags with the <code>preTags</code> and <code>postTags</code> settings.<p class="paragraph"/><div class="code"><pre>def highlightSettings = &#123;
    field 'message'
    preTags '&#60;myAweSomeTag&#62;'
    postTags '&#60;/myAweSomeTag&#62;'
&#125;</pre></div>


<h2 id="sorting">5.7 Sorting</h2>
To sort the search results, either a field name or a SortBuilder must be passed.<p class="paragraph"/><h4>Returned sort values</h4><p class="paragraph"/>The sort values are not part of the search results themselves but are part of <code>result.sort</code>.
<code>sort</code> contains all search values calculated by the ElasticSearch server as a list mapped to the id of the respective domain objects<p class="paragraph"/><h4>Example</h4>
<div class="code"><pre>assert &#91;1:&#91;23, 42&#93;, 2: &#91;24, 40&#93;&#93; == result.sort</pre></div>



<h2 id="geodistanceSorting">5.7.1 geoDistanceSorting</h2>
To sort for geo distances, a SortBuilder must be passed to search()<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>def sortBuilder = SortBuilders.geoDistanceSort(<span class="java&#45;quote">"location"</span>)
    .point(48.141, 11.57)
    .unit(DistanceUnit.KILOMETERS)
    .order(SortOrder.ASC)<p class="paragraph"/>def result = elasticSearchService.search(
    &#91;indices: Building, types: Building, sort: sortBuilder&#93;,
    <span class="java&#45;keyword">null</span> as Closure,
    &#123;
        geo_distance(
            'distance': '5km',
            'location': &#91;lat: 48.141, lon: 11.57&#93;
        )
    &#125;)</pre></div><p class="paragraph"/>The calculated distances are not part of the search results themselves but are part of <code>result.sort</code>.
<code>sort</code> contains all search values calculated by the ElasticSearch server as a list mapped to the id of the respective domain objects<p class="paragraph"/><div class="code"><pre>assert &#91;1:&#91;2.34567&#93;, 2: &#91;2.4402342&#93;&#93; == result.sort</pre></div>



<h1 id="admin">6 Admin</h1>
The plugin implements a few convenience methods for a few admin-oriented actions.



<h2 id="refresh">6.1 Refresh</h2>
Explicitly refresh one or more index, making all operations performed since the last refresh available for search.
It will also flush the current IndexRequestQueue if there are pending index or delete requests from the application side.
The refresh method is not asynchronous, meaning that it will wait for all operations to complete before resuming the execution of your application.<p class="paragraph"/><div class="code"><pre>elasticSearchService.index(domain)
// Some code&#8230;
// &#8230;
elasticSearchService.index(domain2)
// Some code&#8230;
// &#8230;
elasticSearchService.index(domain3)<p class="paragraph"/>// Some code&#8230;
// &#8230;
elasticSearchAdminService.refresh() // Ensure that the 3 previous index requests have been made searchable by ES</pre></div>



<h2 id="deleteIndex">6.2 Delete Index</h2>
Delete an index, all its mapping and its content from the ElasticSearch instance. Be careful when using this command because it cannot be undone.
Note that the generated mapping from the grails plugin is also deleted.<p class="paragraph"/>The method can be limited to one or more specific indices or applied to all indices at once (called with no parameter).<p class="paragraph"/><div class="code"><pre>elasticSearchAdminService.deleteIndex()</pre></div>



<h1 id="lowLevelAPI">7 Low level API</h1>
If you need to use the Elastic Search client directly, you can use the <code>elasticSearchHelper</code> bean that is
injected in any services/controllers to get the current instance.
Simply encapsulate your code within a <code>withElasticSearch</code> bloc,
and you will get a <code>org.elasticsearch.client.Client</code> implementation to play with.<p class="paragraph"/><div class="code"><pre>class MySearchService &#123;
    <span class="java&#45;keyword">static</span> transactional = <span class="java&#45;keyword">true</span><p class="paragraph"/>    def elasticSearchHelper<p class="paragraph"/>    def myMethod(indexName, settings) &#123;
        elasticSearchHelper.withElasticSearch &#123; client &#45;&#62;
            // Do some stuff with the ElasticSearch client
            client.admin()
                .indices()
                .prepareCreate(indexName)
                .setSettings(settings)
                .execute()
                .actionGet()
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Please refers to the <a href="http://www.elasticsearch.org/guide/reference/java-api/" target="blank">Elastic Search API</a> for more
information on the methods and properties available on the client.



<h1 id="example">8 Example</h1>




<h2 id="twitter">8.1 Tweets</h2>




<h2 id="theDomains">8.1.1 The domains</h2>
<div class="code"><pre>class Tweet &#123;
  <span class="java&#45;keyword">static</span> searchable = &#123;
    message boost:2.0
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> belongsTo = &#91;
          user:User
  &#93;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> hasMany = &#91;
          tags:Tag
  &#93;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> constraints = &#123;
    tags nullable:<span class="java&#45;keyword">true</span>, cascade:'save, update'
  &#125;<p class="paragraph"/>  <span class="java&#45;object">String</span> message = ''
  Date dateCreated = <span class="java&#45;keyword">new</span> Date()
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class User &#123;
  <span class="java&#45;keyword">static</span> searchable = &#123;
    except = 'password'
    lastname boost:20
    firstname boost:15, index:'not_analyzed'
    listOfThings index:'no'
    someThings index:'no'
    tweets component:<span class="java&#45;keyword">true</span>
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> constraints = &#123;
    tweets cascade:'all'
  &#125;
  <span class="java&#45;keyword">static</span> hasMany = &#91;
          tweets:Tweet
  &#93;
  <span class="java&#45;keyword">static</span> mappedBy = &#91;
          tweets:'user'
  &#93;<p class="paragraph"/>  <span class="java&#45;object">String</span> lastname
  <span class="java&#45;object">String</span> firstname
  <span class="java&#45;object">String</span> password
  <span class="java&#45;object">String</span> activity = 'Evildoer'
  <span class="java&#45;object">String</span> someThings = 'something'
  ArrayList&#60;<span class="java&#45;object">String</span>&#62; listOfThings = &#91;'<span class="java&#45;keyword">this</span>', 'that', 'andthis'&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Tag &#123;
  <span class="java&#45;keyword">static</span> searchable = &#123;
    except=&#91;'boostValue'&#93;
  &#125;<p class="paragraph"/>  <span class="java&#45;object">String</span> name
  <span class="java&#45;object">Integer</span> boostValue = 1
&#125;</pre></div>



<h2 id="theController">8.1.2 The controller</h2>
<h4>A action triggering indexation</h4>
<code>ElasticSearchController</code> (<code>testCaseService</code> is just dealing with GORM instructions):
<div class="code"><pre>class ElasticSearchController &#123;
  def elasticSearchService
  def testCaseService<p class="paragraph"/>  def postTweet = &#123;
    <span class="java&#45;keyword">if</span>(!params.user?.id) &#123;
      flash.notice = <span class="java&#45;quote">"No user selected."</span>
      redirect(action: 'index')
      <span class="java&#45;keyword">return</span>
    &#125;
    User u = User.get(params.user.id)
    <span class="java&#45;keyword">if</span> (!u) &#123;
      flash.notice = <span class="java&#45;quote">"User not found"</span>
      redirect(action: 'index')
      <span class="java&#45;keyword">return</span>
    &#125;
    // Create tweet
    testCaseService.addTweet(params.tweet?.message, u, params.tags)<p class="paragraph"/>    flash.notice = <span class="java&#45;quote">"Tweet posted"</span>
    redirect(action: 'index')
  &#125;
&#125;</pre></div>
With this code (considering that there are already <code>User</code> in the database), new Tweets will be indexed automatically,
and corresponding <code>User</code> indexed documents will be updated since we have set the <code>tweets</code> association as component.<p class="paragraph"/><h4>Searching for Tweets</h4>
<div class="code"><pre>def searchForUserTweets = &#123;
    def tweets = Tweet.search(<span class="java&#45;quote">"$&#123;params.message.search&#125;"</span>).searchResults
    def tweetsMsg = 'Messages : '
    tweets.each &#123;
      tweetsMsg += <span class="java&#45;quote">"&#60;br /&#62;Tweet from $&#123;it.user?.firstname&#125; $&#123;it.user?.lastname&#125; : $&#123;it.message&#125; "</span>
      tweetsMsg += <span class="java&#45;quote">"(tags : $&#123;it.tags?.collect&#123;t &#45;&#62; t.name&#125;&#125;)"</span>
    &#125;
    flash.notice = tweetsMsg
    redirect(action: 'index')
&#125;</pre></div><p class="paragraph"/><h4>Searching for anything</h4>
<div class="code"><pre>def searchAll = &#123;
    def res = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>).searchResults
    def resMsg = '&#60;strong&#62;Global search result(s):&#60;/strong&#62;&#60;br /&#62;'
    res.each &#123;
      <span class="java&#45;keyword">switch</span>(it)&#123;
        <span class="java&#45;keyword">case</span> Tag:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;Tag&#60;/strong&#62; $&#123;it.name&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
        <span class="java&#45;keyword">case</span> Tweet:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;Tweet&#60;/strong&#62; &#34;$&#123;it.message&#125;&#34; from $&#123;it.user.firstname&#125; $&#123;it.user.lastname&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
        <span class="java&#45;keyword">case</span> User:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;User&#60;/strong&#62; $&#123;it.firstname&#125; $&#123;it.lastname&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
        <span class="java&#45;keyword">default</span>:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;Other&#60;/strong&#62; $&#123;it&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
      &#125;<p class="paragraph"/>    &#125;
    flash.notice = resMsg
    redirect(action:'index')
 &#125;</pre></div>


<h2 id="geoDistanceSearch">8.2 Geo Distance Search</h2>
A search for buildings with a geo_distance filter, ordered by distance.



<h2 id="geoDistanceDomains">8.2.1 Domains</h2>

<div class="code"><pre>class GeoPoint &#123;<p class="paragraph"/>    <span class="java&#45;object">Double</span> lat
    <span class="java&#45;object">Double</span> lon<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        root <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div>
GeoPoint represents the geo coordinates for a building. The field names <code>lat</code> and <code>lon</code> are mandatory.<p class="paragraph"/><div class="code"><pre>class Building &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    GeoPoint location<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        location geoPoint: <span class="java&#45;keyword">true</span>, component: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The location of the building is mapped to an ElasticSearch <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-geo-point-type.html" target="blank">geo_point</a>.



<h2 id="geoDistanceService">8.2.2 Service Methods</h2>
Searching for all buildings sorted by distance with 5km radius around geo location (lat=41.141, lon=11.57)<p class="paragraph"/><div class="code"><pre>def searchForBuildings() &#123;
    Closure filter = &#123;
        geo_distance(
            'distance': '5km',
            'location': &#91;lat: 48.141, lon: 11.57&#93;
        )
    &#125;<p class="paragraph"/>    def sortBuilder = SortBuilders.geoDistanceSort(<span class="java&#45;quote">"location"</span>).
        point(48.141, 11.57).
        unit(DistanceUnit.KILOMETERS).
        order(SortOrder.ASC)<p class="paragraph"/>    def result = elasticSearchService.search(
        &#91;indices: Building, types: Building, sort: sortBuilder&#93;,
        <span class="java&#45;keyword">null</span> as Closure,
        filter)<p class="paragraph"/>    <span class="java&#45;keyword">return</span> &#91;results: result.searchResults, distances: result.sort&#93;
&#125;</pre></div><p class="paragraph"/>The calculated distances are not part of the search results themselves but are part of <code>result.sort</code>.
<code>sort</code> contains all search values calculated by the ElasticSearch server as a list mapped to the id of the respective domain objects<p class="paragraph"/><h4>Example</h4>
<div class="code"><pre>assert &#91;1:&#91;23, 42&#93;, 2: &#91;24, 40&#93;&#93; == result.sort</pre></div>



<h2 id="parentChildExample">8.3 Parent/Child mapping</h2>
A store with many departments
<div class="code"><pre>class Store &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">String</span> description = <span class="java&#45;quote">"A description of a store"</span>
    <span class="java&#45;object">String</span> owner = <span class="java&#45;quote">"Shopowner"</span><p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span><p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        name blank: <span class="java&#45;keyword">false</span>
        description nullable: <span class="java&#45;keyword">true</span>
        owner nullable: <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>class Department &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">Long</span> numberOfProducts
    Store store<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        numberOfProducts nullable: <span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        store parent: <span class="java&#45;keyword">true</span>, component:<span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Search for all departments which are childs of a store with the owner "Shopowner"<p class="paragraph"/><div class="code"><pre>def result = elasticSearchService.search(
    QueryBuilders.hasParentQuery(<span class="java&#45;quote">"store"</span>, QueryBuilders.matchQuery(<span class="java&#45;quote">"owner"</span>, <span class="java&#45;quote">"Shopowner"</span>)),
    <span class="java&#45;keyword">null</span> as Closure,
    &#91;indices: Department, types: Department&#93;
)</pre></div>


                    </div>
                </td>
                <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Dynamic Domain Methods</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/countHits.html">countHits</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/index.html">index</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/search.html">search</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/unindex.html">unindex</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchAdminService</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/ElasticSearchAdminService/deleteIndex.html">deleteIndex</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/ElasticSearchAdminService/refresh.html">refresh</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchService</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/ElasticSearchService/countHits.html">countHits</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/ElasticSearchService/index.html">index</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/ElasticSearchService/search.html">search</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/ElasticSearchService/unindex.html">unindex</a>
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
        </td>
            </tr>
        </table>

        <div id="footer">
            
            
        </div>



<script type="text/javascript" src="../js/docs.js"></script>

    </body>
</html>
