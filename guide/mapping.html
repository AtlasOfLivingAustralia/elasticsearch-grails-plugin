<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3 Mapping 0.0.4.5</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/configuration.html"><strong>2</strong><span>Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/mapping.html"><strong>3</strong><span>Mapping</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/indexing.html"><strong>4</strong><span>Indexing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/searching.html"><strong>5</strong><span>Searching</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/admin.html"><strong>6</strong><span>Admin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/lowLevelAPI.html"><strong>7</strong><span>Low level API</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/example.html"><strong>8</strong><span>Example</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>The revived Elasticsearch plugin for Grails.</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/configuration.html">&lt;&lt; <strong>2</strong><span>Configuration</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/indexing.html"><strong>4</strong><span>Indexing</span> >></a></div>
                


                <div class="project">
                    <h1>3 Mapping - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Noam Y. Tenne, Manuarii Stein, Stephane Maldini, Serge P. Nekoval, Marcos Carceles</p>

                    <p><strong>Version:</strong> 0.0.4.5</p>

                    
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#quickStart"><strong>3.1</strong><span>QuickStart</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#classMapping"><strong>3.2</strong><span>Class Mapping</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#propertiesMapping"><strong>3.3</strong><span>Properties mapping</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#parentChild"><strong>3.3.1</strong><span>Parent-Child</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#geoPoint"><strong>3.3.2</strong><span>GeoPoint</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#alias"><strong>3.3.3</strong><span>Alias</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#dynamic"><strong>3.3.4</strong><span>Dynamic</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#searchableComponentReference"><strong>3.4</strong><span>Searchable Component-Reference</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#searchableReference"><strong>3.4.1</strong><span>Searchable Reference</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#searchableComponent"><strong>3.4.2</strong><span>Searchable Component</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#mappingMigrations"><strong>3.5</strong><span>Mapping Migrations</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="mapping">3 Mapping</h1>
From version 0.0.4.0 in addition to the indices generated by the plugin based on the domain objects package names or configuration, two new aliases are created for every index: <code>&#60;indexName&#62;_read</code> and <code>&#60;indexName&#62;_write</code>. These two aliases are used by the plugin to index and query from Elasticsearch and are needed to centralise the choice of index to use during mapping migrations when the <code>'alias'</code> strategy is used and there are multiple instances of the application.



<h2 id="quickStart">3.1 QuickStart</h2>
<h4>Default mapping</h4>
To declare a domain class to be searchable, the simplest way is to define the following static property in the code:
<div class="code"><pre><span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span></pre></div>
The plugin will generate a default mapping for each properties of the domain.<p class="paragraph"/><h4>Custom mapping</h4>
You can customize how each properties are mapped to the index using a closure. The syntax is similar to GORM's mapping DSL.
<div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
    // mapping DSL&#8230;
&#125;</pre></div>
See below for more details on the mapping DSL.<p class="paragraph"/><h4>Limit properties with only/except</h4>
<code>only</code> and <code>except</code> are used to limit the properties that are made searchable.
You may not define both except &#38; only settings at the same time.<p class="paragraph"/>The following code will only map the 'message' property, any others will be ignored.
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        only = 'message'
    &#125;
    <span class="java&#45;object">String</span> message
    <span class="java&#45;object">String</span> someUselessField
&#125;</pre></div><p class="paragraph"/>The following code will map all properties except the one specified.
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        except = 'someUselessField'
    &#125;
    <span class="java&#45;object">String</span> message
    <span class="java&#45;object">String</span> someUselessField
&#125;</pre></div><p class="paragraph"/>You can use a Collection to specify several properties.
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        except = &#91;'someUselessField', 'userName'&#93;
    &#125;
    <span class="java&#45;object">String</span> message
    <span class="java&#45;object">String</span> userName
    <span class="java&#45;object">String</span> someUselessField
&#125;</pre></div><p class="paragraph"/><blockquote class="note">The properties that are ignored will not be sent to ElasticSearch. It also means that when you will get back a domain
from ElasticSearch, some fields that are not supposed to be null, may still be null.</blockquote><p class="paragraph"/><h4>Including transients</h4><p class="paragraph"/>How the plugin manages transient properties is controlled by the <code>elasticSearch.includeTransients</code> configuration property. If this is set to <code>false</code> only transient properties explictly included in <code>only</code> will be mapped and searchable, if set to <code>true</code>, all domain class properties will be mapped, including <code>transients</code>.<p class="paragraph"/>The following are valid examples<p class="paragraph"/><div class="code"><pre>//assert grailsApplication.config.elasticSearch.includeTransients == <span class="java&#45;keyword">false</span>
class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName
    <span class="java&#45;object">String</span> getFullName() &#123;
        firstName + <span class="java&#45;quote">" "</span> + lastName
    &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'fullName'&#93;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        only = &#91;'fullName'&#93;
    &#125;
&#125;
// <span class="java&#45;keyword">new</span> Person(firstNameme: <span class="java&#45;quote">"Nikola"</span>, lastName: <span class="java&#45;quote">"Tesla"</span>)
// can be found using:
// def tesla = Person.search(<span class="java&#45;quote">"Nikola Tesla"</span>).searchResults.first()</pre></div><p class="paragraph"/><div class="code"><pre>//assert grailsApplication.config.elasticSearch.includeTransients == <span class="java&#45;keyword">true</span>
class Multiplication &#123;
    <span class="java&#45;object">int</span> opA
    <span class="java&#45;object">int</span> opB
    <span class="java&#45;object">int</span> getResult() &#123;
        opA &#42; opB
    &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'result'&#93;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span>
&#125;
// <span class="java&#45;keyword">new</span> Multiplication(opA: 2, opB: 3)
// can be found using:
// def multiplication = Multiplication.search(<span class="java&#45;quote">"2"</span>).searchResults.first()
// def multiplication = Multiplication.search(<span class="java&#45;quote">"3"</span>).searchResults.first()
// def multiplication = Multiplication.search(<span class="java&#45;quote">"6"</span>).searchResults.first()</pre></div><p class="paragraph"/><blockquote class="note">
From the examples above, once the domain object is found, its transient values will be calculated from the information stored on ElasticSearch: <code>multiplication.result == 6</code>, but <code>tesla.fullName == "null null"</code>, as firstName and lastName where not indexed. This behaviour can be prevented by creating convenient setters for the transient properties.
</blockquote><p class="paragraph"/><h4>Transients and collections</h4><p class="paragraph"/>When transient properties are collections the only way the plugin can define the correct ElasticSearch mapping during boot is if the element types are explicitly defined on the grails domain object. For instances of <code>Collection</code> this can be achieved by defining its type on the <code>hasMany</code> property (otherwise the ElasticSearch type will be defined as <code>object</code>). This is not required for arrays.<p class="paragraph"/>Some valid examples:
<div class="code"><pre>class Tweet &#123;
    <span class="java&#45;object">String</span> message
    List getHashtags() &#123; &#8230; &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'hashtags'&#93;
    <span class="java&#45;keyword">static</span> hasMany = &#91;hashtags: <span class="java&#45;object">String</span>&#93;
    <span class="java&#45;keyword">static</span> searchable = &#123;only = 'hashtags' &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class FamilyGuy &#123;
    <span class="java&#45;object">String</span> wife
    <span class="java&#45;object">String</span> son
    <span class="java&#45;object">String</span> daughter
    <span class="java&#45;object">String</span> baby
    <span class="java&#45;object">String</span>&#91;&#93; getRelatives() &#123; &#8230; &#125;
    <span class="java&#45;keyword">static</span> transients = &#91;'relatives'&#93;
    <span class="java&#45;keyword">static</span> searchable = &#123; only = 'relatives' &#125;
&#125;</pre></div>


<h2 id="classMapping">3.2 Class Mapping</h2>
<h4>root</h4>
Determine if the domain class will have its own index or not. Take a boolean as parameter, and is set to <code>true</code> by default.
<div class="code"><pre>class Preference &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        root <span class="java&#45;keyword">false</span>
    &#125;
    // &#8230;
&#125;<p class="paragraph"/>class Tag &#123;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span>
    // &#8230;
&#125;<p class="paragraph"/>class Tweet &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        message boost:2.0
    &#125;
    // &#8230;
&#125;</pre></div>
In this code, the classes <code>Tweet</code> and <code>Tag</code> are going to have their own index. The class <code>Preference</code> will not.
It also mean that any search request will never return a Preference-type hit. The dynamic method <code>search</code> will not be
injected in the <code>Preference</code> domain class.
The domains not root-mapped can still be considered searchable, as they can be components of another domain which is root-mapped.
For example, considered the following domain:
<div class="code"><pre>class User &#123;
    <span class="java&#45;keyword">static</span> searchable = &#123;
        userPreferences component:<span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    Preference userPreferences
&#125;</pre></div>
When searching, any matches in the <code>userPreferences</code> property will be considered as a <code>User</code> match.<p class="paragraph"/><h4>all</h4>
Set default analyzer for all domain class fields.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
  all = &#91;analyzer: 'russian_morphology'&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
  all = <span class="java&#45;keyword">false</span>
&#125;</pre></div><p class="paragraph"/>When disabling the all field, it is a good practice to set index.query.default_field to a different value (for example, if you have a main 'message' field in your data, set it to message).



<h2 id="propertiesMapping">3.3 Properties mapping</h2>
You can customize the mapping for each domain properties using the closure mapping.
The syntax is simple:
<div class="code"><pre><span class="java&#45;keyword">static</span> searchable = &#123;
    propertyName option1:value, option2:value, &#8230;
&#125;</pre></div><p class="paragraph"/><h4>Available options</h4><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Option name</strong></th><th>Values</th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>boost</td><td>Number</td><td>A decimal boost value. With a positive value, promotes search results for hits in this property; with a negative value, demotes search results that hit this property.</td></tr><tr class="table-even"><td><a href="../guide/single.html#searchableComponent" class="guide">component</a></td><td><code>true</code>, <code>false</code></td><td>To use only on domain (or collection of domains), make the property a searchable component.</td></tr><tr class="table-odd"><td>converter</td><td>A <code>Class</code></td><td>A <code>Class</code> to use as a converter during the marshalling/unmarshalling process for that peculiar property. That class must extends the <code>PropertyEditorSupport</code> java class.</td></tr><tr class="table-even"><td>excludeFromAll</td><td><code>true</code>, <code>false</code></td><td>determines if the property is to append in the <code>"_all"</code> field. Default to <code>true</code>.</td></tr><tr class="table-odd"><td>index</td><td><code>"no"</code>, <code>"not_analyzed"</code>, <code>"analyzed"</code>.</td><td>How or if the property is made into searchable element. One of <code>"no"</code>, <code>"not_analyzed"</code> or <code>"analyzed"</code>.</td></tr><tr class="table-even"><td><a href="../guide/single.html#searchableReference" class="guide">reference</a></td><td><code>true</code>, <code>false</code></td><td>To use only on domain (or collection of domains), make the property a searchable reference.</td></tr><tr class="table-odd"><td><a href="../guide/single.html#parentChild" class="guide">parent</a></td><td><code>true</code>, <code>false</code></td><td>A boolean value to be used in conjunction with the <code>reference</code> or <code>component</code> property . Set to <code>true</code> if the referenced field should be mapped as the parent of this document. Default set to <code>false</code>.</td></tr><tr class="table-even"><td>multi_field</td><td><code>true</code>, <code>false</code></td><td>A boolean value. Maps the value of the field twice; Once with it being analyzed, and once with it being not_analyzed under untouched. Default set to <code>false</code>.</td></tr><tr class="table-odd"><td><a href="../guide/single.html#geoPoint" class="guide">geoPoint</a></td><td><code>true</code>, <code>false</code></td><td>Maps the field to a geo_point. Default: <code>false</code></td></tr><tr class="table-even"><td><a href="../guide/single.html#alias" class="guide">alias</a></td><td>String</td><td>A string value.  The field noted with this parameter will be duplicated to an alias</td></tr><tr class="table-odd"><td><a href="../guide/single.html#dynamic" class="guide">dynamic</a></td><td><code>true</code>, <code>false</code></td><td>Only available for String properties. Determines whether this field should be dynamicly mapped by elasticsearch.</td></tr></table>



<h2 id="parentChild">3.3.1 Parent-Child</h2>
To map a parent/child relationship, the child element must either contain the parent element as a component or reference it as a referenced document.
This component must be mapped as a parent in the child element.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class ParentElement &#123;
…
&#125;<p class="paragraph"/>class EmbeddingChild &#123;
    ParentElement parentElement<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        parentElement parent: <span class="java&#45;keyword">true</span>, component: <span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>class ReferencingChild &#123;
    ParentElement parentElement<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        parentElement parent: <span class="java&#45;keyword">true</span>, reference: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>


<h2 id="geoPoint">3.3.2 GeoPoint</h2>
A geographic location can be mapped to a geo_point. The field for the longitude has to be named <code>lon</code> and the field for the latitude has to be named <code>lat</code><p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class GeoPoint &#123;<p class="paragraph"/>    <span class="java&#45;object">Double</span> lat
    <span class="java&#45;object">Double</span> lon<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        root <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>class Building &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    GeoPoint location<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        location geoPoint: <span class="java&#45;keyword">true</span>, component: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div>



<h2 id="alias">3.3.3 Alias</h2>
A field can be aliased.  This is useful in situations where another service may expect certain tags.
For example, <a href="http://www.elasticsearch.org/overview/kibana/" target="blank">Kibana</a> uses an <code>&#64;timestamp</code> field to filter
report records by date.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class Session &#123;<p class="paragraph"/>    Date loginTime<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        loginTime alias:'@timestamp'
    &#125;
&#125;</pre></div>



<h2 id="dynamic">3.3.4 Dynamic</h2>
Elasticsearch can map field contents as dynamic objects.
This is especially useful if you store JSON Strings in your database and want to make those objects searchable in elasticsearch.<p class="paragraph"/><h4>Example</h4><p class="paragraph"/><div class="code"><pre>class Session &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> jsonData<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        dynamic: <span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>Session session = <span class="java&#45;keyword">new</span> Session()
session.jsonData = (&#91;foo: 'bar'&#93; as JSON).toString()</pre></div><p class="paragraph"/>The default mapping would make the jsonData field an escaped String field and
a search for jsonData.foo = bar would result in no result.
With dynamic mapping enabled for this field, we enable JSON handling of this field and tell elasticsearch to map this field dynamicly.
The result is that a search for jsonData.foo=bar would result in a search hit.
Attention: This will only work on String fields and will result in an error if the String is no valid json


<h2 id="searchableComponentReference">3.4 Searchable Component-Reference</h2>
The plugin support a similar searchable-component &#38; searchable-reference behavior from Compass
when you are dealing with domain association.
See below to find out about the difference between both mapping modes.



<h2 id="searchableReference">3.4.1 Searchable Reference</h2>
The searchable-reference mapping mode is the default mode used for association, and requires the
searchable class of the association to be root-mapped in order to have its own index.
With this mode, the associated domains are not completely marshalled in the resulting JSON document:
only the id and the type of the instances are kept.
When the document is retrieved from the index, the plugin will automatically rebuild the association from the
indices using the stored id.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>class MyDomain &#123;
    // odom is an association with the OtherDomain class, set as a reference
    OtherDomain odom<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        odom reference:<span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>// The OtherDomain definition, with <span class="java&#45;keyword">default</span> searchable configuration
class OtherDomain &#123;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span><p class="paragraph"/>    <span class="java&#45;object">String</span> field1 = <span class="java&#45;quote">"val1"</span>
    <span class="java&#45;object">String</span> field2 = <span class="java&#45;quote">"val2"</span>
    <span class="java&#45;object">String</span> field3 = <span class="java&#45;quote">"val3"</span>
    <span class="java&#45;object">String</span> field4 = <span class="java&#45;quote">"val4"</span>
&#125;</pre></div><p class="paragraph"/>When indexing an instance of MyDomain, the resulting JSON documents will be sent to ElasticSearch:
<div class="code"><pre>&#123;
    <span class="java&#45;quote">"mydomain"</span>: &#123;
        <span class="java&#45;quote">"_id"</span>:1,
        <span class="java&#45;quote">"odom"</span>: &#123; <span class="java&#45;quote">"id"</span>:1 &#125;
    &#125;
&#125;<p class="paragraph"/>&#123;
    <span class="java&#45;quote">"otherdomain"</span>: &#123;
        <span class="java&#45;quote">"_id"</span>:1,
        <span class="java&#45;quote">"field1"</span>:<span class="java&#45;quote">"val1"</span>,
        <span class="java&#45;quote">"field2"</span>:<span class="java&#45;quote">"val2"</span>,
        <span class="java&#45;quote">"field3"</span>:<span class="java&#45;quote">"val3"</span>,
        <span class="java&#45;quote">"field4"</span>:<span class="java&#45;quote">"val4"</span>
    &#125;
&#125;</pre></div>



<h2 id="searchableComponent">3.4.2 Searchable Component</h2>
The searchable-component mapping mode must be explicitly set, and does not require the
searchable class of the association to be root-mapped.
With this mode, the associated domains are nested in the parent document.<p class="paragraph"/><strong class="bold">Example</strong>
<div class="code"><pre>class MyDomain &#123;
    // odom is an association with the OtherDomain class, set as a reference
    OtherDomain odom<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        odom component:<span class="java&#45;keyword">true</span>
    &#125;
&#125;<p class="paragraph"/>// The OtherDomain definition, with <span class="java&#45;keyword">default</span> searchable configuration
class OtherDomain &#123;
    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span><p class="paragraph"/>    <span class="java&#45;object">String</span> field1 = <span class="java&#45;quote">"val1"</span>
    <span class="java&#45;object">String</span> field2 = <span class="java&#45;quote">"val2"</span>
    <span class="java&#45;object">String</span> field3 = <span class="java&#45;quote">"val3"</span>
    <span class="java&#45;object">String</span> field4 = <span class="java&#45;quote">"val4"</span>
&#125;</pre></div><p class="paragraph"/>When indexing an instance of MyDomain, the resulting JSON document will be sent to ElasticSearch:
<div class="code"><pre>&#123;
    <span class="java&#45;quote">"mydomain"</span>: &#123;
        <span class="java&#45;quote">"_id"</span>:1,
        <span class="java&#45;quote">"odom"</span>: &#123;
            <span class="java&#45;quote">"_id"</span>:1,
            <span class="java&#45;quote">"field1"</span>:<span class="java&#45;quote">"val1"</span>,
            <span class="java&#45;quote">"field2"</span>:<span class="java&#45;quote">"val2"</span>,
            <span class="java&#45;quote">"field3"</span>:<span class="java&#45;quote">"val3"</span>,
            <span class="java&#45;quote">"field4"</span>:<span class="java&#45;quote">"val4"</span>
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>If you'd rather that the reference object be mapped with type 'inner' rather than the default 'nested', set the 'component' key with a value of 'inner' rather than 'true':
<div class="code"><pre>class MyDomain &#123;
    // odom is an association with the OtherDomain class, set as a reference
    OtherDomain odom<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        odom component: '<span class="java&#45;keyword">inner</span>'
    &#125;
&#125;</pre></div>


<h2 id="mappingMigrations">3.5 Mapping Migrations</h2>
During the application startup the application will attempt to create the needed indices on Elasticsearch and create the type mappings defined by the user. If these indices and mappings already existed on the Elasticsearch cluster (ie. an older verion of the application was running against it) and the new mapping definitions differ with the existing ones there's the potential for a Mapping conflict. This section describes how to configure the application to deal with this scenario.<p class="paragraph"/>It is important to highlight that not all type mapping changes will result on a conflict. Ie. adding a new field to a mapping does not result in a conflict whilst changing a property from component:'inner' to nested or viceversa, will. These strategies will only be needed and applied when a <strong class="bold">conflicting</strong> mapping is found.<p class="paragraph"/><h3>Migration Strategies</h3>
The migration strategy is defined by the <code>elasticSearch.migration.strategy</code> configuration property and it accepts three values:
<ul class="minus">
<li><code>'none'</code></li>
<li><code>'delete'</code></li>
<li><code>'alias'</code></li>
</ul><p class="paragraph"/>The default strategy is <code>'alias'</code> as it is the only strategy that can achieve zero-downtime migrations and thus <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">recommended by Elasticsearch</a><p class="paragraph"/>These values are described on more detail further ahead<p class="paragraph"/><h4>Migration Strategy 'none'</h4><p class="paragraph"/>This option keeps the original behaviour the plugin used before the Migration Strategies were implemented. When a Mapping Merge conflict id identified the event will be logged and an Exception will be logged.
It will be responsability for the application administrator to manually fix the problem.
This configuration was left as a backwards compatibility and it will prevent the application from booting successfully, therefore we <strong class="bold">discourage teams from using this option</strong>.<p class="paragraph"/><h4>Migration Strategy 'delete'</h4><p class="paragraph"/>When choosing this option, when a conflict occurs installing  mapping, the application will delete the existing mapping for the type, alongside with all content indexed on that index and type and recreated the mapping. There are a couple of important details on this information:
<ul class="minus">
<li>Only documents indexed on the conflicting mapping will be deleted, any other document on a different mapping on the same (or other) index will remain untouched.</li>
<li>Deleted documents can be automatically reindexed on startup by using the <code>elasticSearch.bulkIndexOnStartup</code> configuration property (See below)</li>
<li>Using this configuration there will always be a time window (between deletion and reindexation) where documents can't be found by search, therefore this option cannot achieve a <strong class="bold">zero-downtime</strong> deployment</li>
</ul><p class="paragraph"/>See Dealing with deleted content below for more details on automatic indexing.<p class="paragraph"/><h4>Migration Strategy 'alias'</h4><p class="paragraph"/>This is the migration strategy <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">recommended by Elasticsearch</a>.<p class="paragraph"/>To better understand this strategy we will describe a typical <code>'alias'</code> migration.<p class="paragraph"/><div class="code"><pre>Elasticsearch contains
  index 'myapplication.store_v27' with types 'car' and 'motorbike'
  alias 'myapplication.store' pointing to 'myapplication.store_v27'
  'myapplication.store_v27/car' contains 520 documents
  'myapplication.store_v27/motorbike' contains 12 documents
  index 'myapplication.admin_v0' with type 'quote'
  alias 'myapplication.admin' pointing to 'myapplication.admin_v0'
  'myapplication.admin_v0/quote' contains 3200 documents<p class="paragraph"/>The application is configured to use indexes based on <span class="java&#45;keyword">package</span> names 'myapplication.store' and 'myapplication.admin'
(which as we already explained are actually aliases that point to versioned indices)<p class="paragraph"/>The team introduced a change on the Car domain that results in a conflict on the 'car' mapping<p class="paragraph"/>The application starts up
    Tries to install the mapping <span class="java&#45;keyword">for</span> 'motorbike', it detects the conflict
    Creates a <span class="java&#45;keyword">new</span> index called 'myapplication.store_v28'
    Creates mappings 'myapplication.store_v28/car' and 'myapplication.store_v28/motorbike'
    Points all indexing requests <span class="java&#45;keyword">for</span> Car and Motorbike to the <span class="java&#45;keyword">new</span> index, <span class="java&#45;keyword">while</span> queries still happen on 'myapplication.store'
On Boostrap (bulkIndexOnStartup)
    It indexes 520 cars into 'myapplication.store_v28/car'
    It indexes 12 motorbikes into 'myapplication.store_v28/motorbike'
    Switches the 'myapplication.store' alias to point to 'myapplication.store_v28'
    Now all cars are indexed according to the <span class="java&#45;keyword">new</span> mapping
    Now all motorbikes are indexed according to the <span class="java&#45;keyword">new</span> mapping</pre></div><p class="paragraph"/><blockquote class="note">
All content can be queried at all times, during Bootstrap bulkIndexOnStartup content will be retrieved from the old index.
</blockquote><p class="paragraph"/><blockquote class="warning">
Eventhough there wasn't a conflict on 'car', all cars needed to be reindexed as they lived on the same index.
</blockquote><p class="paragraph"/>There are three potential scenarios when using the <code>'alias'</code> strategy:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Scenario</th><th>Behaviour</th></tr><tr class="table-odd"><td>The index (ie. 'myapplication.store') does not exist</td><td>On this case there is not possibility of conflicts, as no previous mapping exist. However the application will behave slightly different than on the other to scenarios. Instead of creating the index (ie. 'myapplication.store'), it will create version 0 of it (ie. 'myapplication.store_v0') and an alias pointint to it. This is to facilitate the creation of future versions in case of conflict.</td></tr><tr class="table-even"><td>Alias exists pointing to a version (ie. 'myapplication.store' -&#62; 'myapplication.store_v27')</td><td>If there's a conflict on a mapping on the index, it will create a new version (ie. 'myapplication.store_v28'), reindex the content or not depending on the value of the <code>elasticSearch.bulkIndexOnStartup</code> configuration property and point the alias to the new version once done.</td></tr><tr class="table-odd"><td>Index already exists (ie. 'myapplication.store')</td><td>Elasticsearch cannot rename an index or create an alias with the same name as an index. The two alternatives here are to delete the index or fail the migration. This is controlled by the <code>elasticSearch.migration.aliasReplacesIndex</code> configuration property, if set to true, it will delete the index and proceed the same way as when the index did not exist. The deleted documents will be reindexed or not depending on the value of the <code>elasticSearch.bulkIndexOnStartup</code>. <strong class="bold">This is the only scenario where there is content loss/downtime using the <code>'alias'</code> strategy.</strong></td></tr></table><p class="paragraph"/>In the case you wanted to create a new version of an index, but not change where the alias points to (ie. for testing or if you wanted to perform extra tasks on the index before updating the alias), the <code>elasticSearch.migration.disableAliasChange</code> configuration property can be used<p class="paragraph"/><blockquote class="note">
Aliases will only point to the new version of the index once all content is reindexed (if chosen to). Meanwhile, all index requests, either by <code>elasticSearchService</code> or using dynamic finders will go to the new version of the index, whilst queries will go to the old version of the index.
</blockquote><p class="paragraph"/>See Dealing with deleted content below for more details on automatic indexing.<p class="paragraph"/><h4>Dealing with deleted content</h4><p class="paragraph"/>Using the <code>'delete'</code> or <code>'alias'</code> strategy may lead to deleting content stored on Elasticsearch. This content can be automatically reindexed using the <code>elasticSearch.bulkIndexOnStartup</code>. The duration of this process will depend on the amount of content to index.<p class="paragraph"/>When this property is set to <code>true</code> all content will be deleted. When set to <code>'deleted'</code> only the domain classes which documents where deleted will be indexed. In either case, when using the <code>'alias'</code> strategy, once all content is indexed all aliases will point to the latest version of the index.


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/configuration.html">&lt;&lt; <strong>2</strong><span>Configuration</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/indexing.html"><strong>4</strong><span>Indexing</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Dynamic Domain Methods</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/countHits.html">countHits</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/index.html">index</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/search.html">search</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/unindex.html">unindex</a>
                            </div>
                            
                            </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchAdminService</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchAdminService/deleteIndex.html">deleteIndex</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchAdminService/refresh.html">refresh</a>
                            </div>
                            
                            </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchService</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/countHits.html">countHits</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/index.html">index</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/search.html">search</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/unindex.html">unindex</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
