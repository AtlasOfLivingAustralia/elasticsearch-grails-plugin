<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3.5 Mapping Migrations 0.0.4.0</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/configuration.html"><strong>2</strong><span>Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/mapping.html"><strong>3</strong><span>Mapping</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/indexing.html"><strong>4</strong><span>Indexing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/searching.html"><strong>5</strong><span>Searching</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/admin.html"><strong>6</strong><span>Admin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/lowLevelAPI.html"><strong>7</strong><span>Low level API</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/example.html"><strong>8</strong><span>Example</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>The revived Elasticsearch plugin for Grails.</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/configuration.html">&lt;&lt; <strong>2</strong><span>Configuration</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/indexing.html"><strong>4</strong><span>Indexing</span> >></a></div>
                


                <div class="project">
                    <h1>3.5 Mapping Migrations - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Noam Y. Tenne, Manuarii Stein, Stephane Maldini, Serge P. Nekoval, Marcos Carceles</p>

                    <p><strong>Version:</strong> 0.0.4.0</p>

                    
                </div>

                

                

<h2 id="mappingMigrations">3.5 Mapping Migrations</h2>
During the application startup the application will attempt to create the needed indices on Elasticsearch and create the type mappings defined by the user. If these indices and mappings already existed on the Elasticsearch cluster (ie. an older verion of the application was running against it) and the new mapping definitions differ with the existing ones there's the potential for a Mapping conflict. This section describes how to configure the application to deal with this scenario.<p class="paragraph"/>It is important to highlight that not all type mapping changes will result on a conflict. Ie. adding a new field to a mapping does not result in a conflict whilst changing a property from component:'inner' to nested or viceversa, will. These strategies will only be needed and applied when a <strong class="bold">conflicting</strong> mapping is found.<p class="paragraph"/><h3>Migration Strategies</h3>
The migration strategy is defined by the <code>elasticSearch.migration.strategy</code> configuration property and it accepts three values:
<ul class="minus">
<li><code>'none'</code></li>
<li><code>'delete'</code></li>
<li><code>'alias'</code></li>
</ul><p class="paragraph"/>The default strategy is <code>'alias'</code> as it is the only strategy that can achieve zero-downtime migrations and thus <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">recommended by Elasticsearch</a><p class="paragraph"/>These values are described on more detail further ahead<p class="paragraph"/><h4>Migration Strategy 'none'</h4><p class="paragraph"/>This option keeps the original behaviour the plugin used before the Migration Strategies were implemented. When a Mapping Merge conflict id identified the event will be logged and an Exception will be logged.
It will be responsability for the application administrator to manually fix the problem.
This configuration was left as a backwards compatibility and it will prevent the application from booting successfully, therefore we <strong class="bold">discourage teams from using this option</strong>.<p class="paragraph"/><h4>Migration Strategy 'delete'</h4><p class="paragraph"/>When choosing this option, when a conflict occurs installing  mapping, the application will delete the existing mapping for the type, alongside with all content indexed on that index and type and recreated the mapping. There are a couple of important details on this information:
<ul class="minus">
<li>Only documents indexed on the conflicting mapping will be deleted, any other document on a different mapping on the same (or other) index will remain untouched.</li>
<li>Deleted documents can be automatically reindexed on startup by using the <code>elasticSearch.bulkIndexOnStartup</code> configuration property (See below)</li>
<li>Using this configuration there will always be a time window (between deletion and reindexation) where documents can't be found by search, therefore this option cannot achieve a <strong class="bold">zero-downtime</strong> deployment</li>
</ul><p class="paragraph"/>See Dealing with deleted content below for more details on automatic indexing.<p class="paragraph"/><h4>Migration Strategy 'alias'</h4><p class="paragraph"/>This is the migration strategy <a href="http://www.elasticsearch.org/blog/changing-mapping-with-zero-downtime/" target="blank">recommended by Elasticsearch</a>.<p class="paragraph"/>To better understand this strategy we will describe a typical <code>'alias'</code> migration.<p class="paragraph"/><div class="code"><pre>Elasticsearch contains
  index 'myapplication.store_v27' with types 'car' and 'motorbike'
  alias 'myapplication.store' pointing to 'myapplication.store_v27'
  'myapplication.store_v27/car' contains 520 documents
  'myapplication.store_v27/motorbike' contains 12 documents
  index 'myapplication.admin_v0' with type 'quote'
  alias 'myapplication.admin' pointing to 'myapplication.admin_v0'
  'myapplication.admin_v0/quote' contains 3200 documents<p class="paragraph"/>The application is configured to use indexes based on <span class="java&#45;keyword">package</span> names 'myapplication.store' and 'myapplication.admin'
(which as we already explained are actually aliases that point to versioned indices)<p class="paragraph"/>The team introduced a change on the Car domain that results in a conflict on the 'car' mapping<p class="paragraph"/>The application starts up
    Tries to install the mapping <span class="java&#45;keyword">for</span> 'motorbike', it detects the conflict
    Creates a <span class="java&#45;keyword">new</span> index called 'myapplication.store_v28'
    Creates mappings 'myapplication.store_v28/car' and 'myapplication.store_v28/motorbike'
    Points all indexing requests <span class="java&#45;keyword">for</span> Car and Motorbike to the <span class="java&#45;keyword">new</span> index, <span class="java&#45;keyword">while</span> queries still happen on 'myapplication.store'
On Boostrap (bulkIndexOnStartup)
    It indexes 520 cars into 'myapplication.store_v28/car'
    It indexes 12 motorbikes into 'myapplication.store_v28/motorbike'
    Switches the 'myapplication.store' alias to point to 'myapplication.store_v28'
    Now all cars are indexed according to the <span class="java&#45;keyword">new</span> mapping
    Now all motorbikes are indexed according to the <span class="java&#45;keyword">new</span> mapping</pre></div><p class="paragraph"/><blockquote class="note">
All content can be queried at all times, during Bootstrap bulkIndexOnStartup content will be retrieved from the old index.
</blockquote><p class="paragraph"/><blockquote class="warning">
Eventhough there wasn't a conflict on 'car', all cars needed to be reindexed as they lived on the same index.
</blockquote><p class="paragraph"/>There are three potential scenarios when using the <code>'alias'</code> strategy:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Scenario</th><th>Behaviour</th></tr><tr class="table-odd"><td>The index (ie. 'myapplication.store') does not exist</td><td>On this case there is not possibility of conflicts, as no previous mapping exist. However the application will behave slightly different than on the other to scenarios. Instead of creating the index (ie. 'myapplication.store'), it will create version 0 of it (ie. 'myapplication.store_v0') and an alias pointint to it. This is to facilitate the creation of future versions in case of conflict.</td></tr><tr class="table-even"><td>Alias exists pointing to a version (ie. 'myapplication.store' -&#62; 'myapplication.store_v27')</td><td>If there's a conflict on a mapping on the index, it will create a new version (ie. 'myapplication.store_v28'), reindex the content or not depending on the value of the <code>elasticSearch.bulkIndexOnStartup</code> configuration property and point the alias to the new version once done.</td></tr><tr class="table-odd"><td>Index already exists (ie. 'myapplication.store')</td><td>Elasticsearch cannot rename an index or create an alias with the same name as an index. The two alternatives here are to delete the index or fail the migration. This is controlled by the <code>elasticSearch.migration.aliasReplacesIndex</code> configuration property, if set to true, it will delete the index and proceed the same way as when the index did not exist. The deleted documents will be reindexed or not depending on the value of the <code>elasticSearch.bulkIndexOnStartup</code>. <strong class="bold">This is the only scenario where there is content loss/downtime using the <code>'alias'</code> strategy.</strong></td></tr></table><p class="paragraph"/>In the case you wanted to create a new version of an index, but not change where the alias points to (ie. for testing or if you wanted to perform extra tasks on the index before updating the alias), the <code>elasticSearch.migration.disableAliasChange</code> configuration property can be used<p class="paragraph"/><blockquote class="note">
Aliases will only point to the new version of the index once all content is reindexed (if chosen to). Meanwhile, all index requests, either by <code>elasticSearchService</code> or using dynamic finders will go to the new version of the index, whilst queries will go to the old version of the index.
</blockquote><p class="paragraph"/>See Dealing with deleted content below for more details on automatic indexing.<p class="paragraph"/><h4>Dealing with deleted content</h4><p class="paragraph"/>Using the <code>'delete'</code> or <code>'alias'</code> strategy may lead to deleting content stored on Elasticsearch. This content can be automatically reindexed using the <code>elasticSearch.bulkIndexOnStartup</code>. The duration of this process will depend on the amount of content to index.<p class="paragraph"/>When this property is set to <code>true</code> all content will be deleted. When set to <code>'deleted'</code> only the domain classes which documents where deleted will be indexed. In either case, when using the <code>'alias'</code> strategy, once all content is indexed all aliases will point to the latest version of the index.


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/configuration.html">&lt;&lt; <strong>2</strong><span>Configuration</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/indexing.html"><strong>4</strong><span>Indexing</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Dynamic Domain Methods</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/Dynamic%20Domain%20Methods/countHits.html">countHits</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Dynamic%20Domain%20Methods/index.html">index</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Dynamic%20Domain%20Methods/search.html">search</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Dynamic%20Domain%20Methods/unindex.html">unindex</a>
                            </div>
                            
                            </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchAdminService</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/ElasticSearchAdminService/deleteIndex.html">deleteIndex</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/ElasticSearchAdminService/refresh.html">refresh</a>
                            </div>
                            
                            </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchService</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/ElasticSearchService/countHits.html">countHits</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/ElasticSearchService/index.html">index</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/ElasticSearchService/search.html">search</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/ElasticSearchService/unindex.html">unindex</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
